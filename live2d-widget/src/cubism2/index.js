import{L2DMatrix44,L2DTargetPoint,L2DViewMatrix}from"./Live2DFramework.js";import LAppDefine from"./LAppDefine.js";import MatrixStack from"./utils/MatrixStack.js";import LAppLive2DManager from"./LAppLive2DManager.js";import logger from"../logger.js";function normalizePoint(e,t,i,n,s,a){e-=i,t-=n;let r=0,o=0;return r=0<=e?e/(s-i):e/i,o=0<=t?t/(a-n):t/n,{vx:r,vy:-o}}class Cubism2Model{constructor(){this.live2DMgr=new LAppLive2DManager,this.isDrawStart=!1,this.gl=null,this.canvas=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null,this.oldLen=0,this._boundMouseEvent=this.mouseEvent.bind(this),this._boundTouchEvent=this.touchEvent.bind(this)}initL2dCanvas(e){this.canvas=document.getElementById(e),this.canvas.addEventListener&&(this.canvas.addEventListener("mousewheel",this._boundMouseEvent,!1),this.canvas.addEventListener("click",this._boundMouseEvent,!1),document.addEventListener("mousemove",this._boundMouseEvent,!1),document.addEventListener("mouseout",this._boundMouseEvent,!1),this.canvas.addEventListener("contextmenu",this._boundMouseEvent,!1),this.canvas.addEventListener("touchstart",this._boundTouchEvent,!1),this.canvas.addEventListener("touchend",this._boundTouchEvent,!1),this.canvas.addEventListener("touchmove",this._boundTouchEvent,!1))}async init(e,t,i){this.initL2dCanvas(e);var e=this.canvas.width,n=this.canvas.height,s=(this.dragMgr=new L2DTargetPoint,n/e),a=LAppDefine.VIEW_LOGICAL_LEFT,r=LAppDefine.VIEW_LOGICAL_RIGHT,o=-s;this.viewMatrix=new L2DViewMatrix,this.viewMatrix.setScreenRect(a,r,o,s),this.viewMatrix.setMaxScreenRect(LAppDefine.VIEW_LOGICAL_MAX_LEFT,LAppDefine.VIEW_LOGICAL_MAX_RIGHT,LAppDefine.VIEW_LOGICAL_MAX_BOTTOM,LAppDefine.VIEW_LOGICAL_MAX_TOP),this.viewMatrix.setMaxScale(LAppDefine.VIEW_MAX_SCALE),this.viewMatrix.setMinScale(LAppDefine.VIEW_MIN_SCALE),this.projMatrix=new L2DMatrix44,this.projMatrix.multScale(1,e/n),this.deviceToScreen=new L2DMatrix44,this.deviceToScreen.multTranslate(-e/2,-n/2),this.deviceToScreen.multScale(2/e,-2/e),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!0,preserveDrawingBuffer:!0}),this.gl?(Live2D.setGL(this.gl),this.gl.clearColor(0,0,0,0),await this.changeModelWithJSON(t,i),this.startDraw()):logger.error("Failed to create WebGL context.")}destroy(){this.canvas&&(this.canvas.removeEventListener("mousewheel",this._boundMouseEvent,!1),this.canvas.removeEventListener("click",this._boundMouseEvent,!1),document.removeEventListener("mousemove",this._boundMouseEvent,!1),document.removeEventListener("mouseout",this._boundMouseEvent,!1),this.canvas.removeEventListener("contextmenu",this._boundMouseEvent,!1),this.canvas.removeEventListener("touchstart",this._boundTouchEvent,!1),this.canvas.removeEventListener("touchend",this._boundTouchEvent,!1),this.canvas.removeEventListener("touchmove",this._boundTouchEvent,!1)),this._drawFrameId&&(window.cancelAnimationFrame(this._drawFrameId),this._drawFrameId=null),this.isDrawStart=!1,this.live2DMgr&&"function"==typeof this.live2DMgr.release&&this.live2DMgr.release(),this.gl,this.canvas=null,this.gl=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null}startDraw(){if(!this.isDrawStart){this.isDrawStart=!0;let e=()=>{this.draw(),this._drawFrameId=window.requestAnimationFrame(e,this.canvas)};e()}}draw(){MatrixStack.reset(),MatrixStack.loadIdentity(),this.dragMgr.update(),this.live2DMgr.setDrag(this.dragMgr.getX(),this.dragMgr.getY()),this.gl.clear(this.gl.COLOR_BUFFER_BIT),MatrixStack.multMatrix(this.projMatrix.getArray()),MatrixStack.multMatrix(this.viewMatrix.getArray()),MatrixStack.push();var e=this.live2DMgr.getModel();null!=e&&(e.initialized&&!e.updating&&(e.update(),e.draw(this.gl)),MatrixStack.pop())}async changeModel(e){await this.live2DMgr.changeModel(this.gl,e)}async changeModelWithJSON(e,t){await this.live2DMgr.changeModelWithJSON(this.gl,e,t)}modelScaling(e){var t=this.viewMatrix.isMaxScale(),i=this.viewMatrix.isMinScale();this.viewMatrix.adjustScale(0,0,e),t||this.viewMatrix.isMaxScale()&&this.live2DMgr.maxScaleEvent(),i||this.viewMatrix.isMinScale()&&this.live2DMgr.minScaleEvent()}modelTurnHead(e){var t=this.canvas.getBoundingClientRect(),{vx:t,vy:i}=normalizePoint(e.clientX,e.clientY,t.left+t.width/2,t.top+t.height/2,window.innerWidth,window.innerHeight);logger.trace("onMouseDown device( x:"+e.clientX+" y:"+e.clientY+" ) view( x:"+t+" y:"+i+")"),this.dragMgr.setPoint(t,i),this.live2DMgr.tapEvent(t,i),this.live2DMgr?.model.hitTest(LAppDefine.HIT_AREA_BODY,t,i)&&window.dispatchEvent(new Event("live2d:tapbody"))}followPointer(e){var t=this.canvas.getBoundingClientRect(),{vx:t,vy:i}=normalizePoint(e.clientX,e.clientY,t.left+t.width/2,t.top+t.height/2,window.innerWidth,window.innerHeight);logger.trace("onMouseMove device( x:"+e.clientX+" y:"+e.clientY+" ) view( x:"+t+" y:"+i+")"),this.dragMgr.setPoint(t,i),this.live2DMgr?.model.hitTest(LAppDefine.HIT_AREA_BODY,t,i)&&window.dispatchEvent(new Event("live2d:hoverbody"))}lookFront(){this.dragMgr.setPoint(0,0)}mouseEvent(e){e.preventDefault(),"mousewheel"==e.type?0<e.wheelDelta?this.modelScaling(1.1):this.modelScaling(.9):"click"==e.type||"contextmenu"==e.type?this.modelTurnHead(e):"mousemove"==e.type?this.followPointer(e):"mouseout"==e.type&&this.lookFront()}touchEvent(e){e.preventDefault();var t,i=e.touches[0];"touchstart"==e.type?1==e.touches.length&&this.modelTurnHead(i):"touchmove"==e.type?(this.followPointer(i),2==e.touches.length&&(i=e.touches[0],t=e.touches[1],i=Math.pow(i.pageX-t.pageX,2)+Math.pow(i.pageY-t.pageY,2),this.oldLen-i<0?this.modelScaling(1.025):this.modelScaling(.975),this.oldLen=i)):"touchend"==e.type&&this.lookFront()}transformViewX(e){e=this.deviceToScreen.transformX(e);return this.viewMatrix.invertTransformX(e)}transformViewY(e){e=this.deviceToScreen.transformY(e);return this.viewMatrix.invertTransformY(e)}transformScreenX(e){return this.deviceToScreen.transformX(e)}transformScreenY(e){return this.deviceToScreen.transformY(e)}}export default Cubism2Model;