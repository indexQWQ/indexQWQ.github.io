import{L2DBaseModel,Live2DFramework,L2DEyeBlink}from"./Live2DFramework.js";import ModelSettingJson from"./utils/ModelSettingJson.js";import LAppDefine from"./LAppDefine.js";import MatrixStack from"./utils/MatrixStack.js";import logger from"../logger.js";class LAppModel extends L2DBaseModel{constructor(){super(),this.modelHomeDir="",this.modelSetting=null,this.tmpMatrix=[]}loadJSON(s){var t=this.modelHomeDir+this.modelSetting.getModelFile();this.loadModelData(t,t=>{for(let t=0;t<this.modelSetting.getTextureNum();t++){var e=this.modelHomeDir+this.modelSetting.getTextureFile(t);this.loadTexture(t,e,()=>{if(this.isTexLoaded){if(0<this.modelSetting.getExpressionNum()){this.expressions={};for(let t=0;t<this.modelSetting.getExpressionNum();t++){var e=this.modelSetting.getExpressionName(t),i=this.modelHomeDir+this.modelSetting.getExpressionFile(t);this.loadExpression(e,i)}}else this.expressionManager=null,this.expressions={};var t;null==this.eyeBlink&&(this.eyeBlink=new L2DEyeBlink),null!=this.modelSetting.getPhysicsFile()?this.loadPhysics(this.modelHomeDir+this.modelSetting.getPhysicsFile()):this.physics=null,null!=this.modelSetting.getPoseFile()?this.loadPose(this.modelHomeDir+this.modelSetting.getPoseFile(),()=>{this.pose.updateParam(this.live2DModel)}):this.pose=null,null!=this.modelSetting.getLayout()&&(null!=(t=this.modelSetting.getLayout()).width&&this.modelMatrix.setWidth(t.width),null!=t.height&&this.modelMatrix.setHeight(t.height),null!=t.x&&this.modelMatrix.setX(t.x),null!=t.y&&this.modelMatrix.setY(t.y),null!=t.center_x&&this.modelMatrix.centerX(t.center_x),null!=t.center_y&&this.modelMatrix.centerY(t.center_y),null!=t.top&&this.modelMatrix.top(t.top),null!=t.bottom&&this.modelMatrix.bottom(t.bottom),null!=t.left&&this.modelMatrix.left(t.left),null!=t.right)&&this.modelMatrix.right(t.right);for(let t=0;t<this.modelSetting.getInitParamNum();t++)this.live2DModel.setParamFloat(this.modelSetting.getInitParamID(t),this.modelSetting.getInitParamValue(t));for(let t=0;t<this.modelSetting.getInitPartsVisibleNum();t++)this.live2DModel.setPartsOpacity(this.modelSetting.getInitPartsVisibleID(t),this.modelSetting.getInitPartsVisibleValue(t));this.live2DModel.saveParam(),this.preloadMotionGroup(LAppDefine.MOTION_GROUP_IDLE),this.mainMotionManager.stopAllMotions(),this.setUpdating(!1),this.setInitialized(!0),"function"==typeof s&&s()}})}})}async loadModelSetting(t,e){this.setUpdating(!0),this.setInitialized(!1),this.modelHomeDir=t.substring(0,t.lastIndexOf("/")+1),this.modelSetting=new ModelSettingJson,this.modelSetting.json=e,await new Promise(t=>this.loadJSON(t))}load(t,e,i){this.setUpdating(!0),this.setInitialized(!1),this.modelHomeDir=e.substring(0,e.lastIndexOf("/")+1),this.modelSetting=new ModelSettingJson,this.modelSetting.loadModelSetting(e,()=>{this.loadJSON(i)})}release(t){var e=Live2DFramework.getPlatformManager();t.deleteTexture(e.texture)}preloadMotionGroup(i){for(let e=0;e<this.modelSetting.getMotionNum(i);e++){var t=this.modelSetting.getMotionFile(i,e);this.loadMotion(t,this.modelHomeDir+t,t=>{t.setFadeIn(this.modelSetting.getMotionFadeIn(i,e)),t.setFadeOut(this.modelSetting.getMotionFadeOut(i,e))})}}update(){var t;null==this.live2DModel?logger.error("Failed to update."):(t=2*((UtSystem.getUserTimeMSec()-this.startTimeMSec)/1e3)*Math.PI,this.mainMotionManager.isFinished()&&this.startRandomMotion(LAppDefine.MOTION_GROUP_IDLE,LAppDefine.PRIORITY_IDLE),this.live2DModel.loadParam(),this.mainMotionManager.updateParam(this.live2DModel)||null!=this.eyeBlink&&this.eyeBlink.updateParam(this.live2DModel),this.live2DModel.saveParam(),null==this.expressionManager||null==this.expressions||this.expressionManager.isFinished()||this.expressionManager.updateParam(this.live2DModel),this.live2DModel.addToParamFloat("PARAM_ANGLE_X",30*this.dragX,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",30*this.dragY,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",this.dragX*this.dragY*-30,1),this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",10*this.dragX,1),this.live2DModel.addToParamFloat("PARAM_EYE_BALL_X",this.dragX,1),this.live2DModel.addToParamFloat("PARAM_EYE_BALL_Y",this.dragY,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_X",Number(15*Math.sin(t/6.5345)),.5),this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",Number(8*Math.sin(t/3.5345)),.5),this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",Number(10*Math.sin(t/5.5345)),.5),this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",Number(4*Math.sin(t/15.5345)),.5),this.live2DModel.setParamFloat("PARAM_BREATH",Number(.5+.5*Math.sin(t/3.2345)),1),null!=this.physics&&this.physics.updateParam(this.live2DModel),null==this.lipSync&&this.live2DModel.setParamFloat("PARAM_MOUTH_OPEN_Y",this.lipSyncValue),null!=this.pose&&this.pose.updateParam(this.live2DModel),this.live2DModel.update())}setRandomExpression(){var t,e=[];for(t in this.expressions)e.push(t);var i=parseInt(Math.random()*e.length);this.setExpression(e[i])}startRandomMotion(t,e){var i=this.modelSetting.getMotionNum(t),i=parseInt(Math.random()*i);this.startMotion(t,i,e)}startMotion(i,s,o){var t=this.modelSetting.getMotionFile(i,s);if(null!=t&&""!=t){if(o==LAppDefine.PRIORITY_FORCE)this.mainMotionManager.setReservePriority(o);else if(!this.mainMotionManager.reserveMotion(o))return void logger.trace("Motion is running.");let e;null==this.motions[i]?this.loadMotion(null,this.modelHomeDir+t,t=>{e=t,this.setFadeInFadeOut(i,s,o,e)}):(e=this.motions[i],this.setFadeInFadeOut(i,s,o,e))}}setFadeInFadeOut(t,e,i,s){var o=this.modelSetting.getMotionFile(t,e);s.setFadeIn(this.modelSetting.getMotionFadeIn(t,e)),s.setFadeOut(this.modelSetting.getMotionFadeOut(t,e)),logger.trace("Start motion : "+o),null!=this.modelSetting.getMotionSound(t,e)&&(o=this.modelSetting.getMotionSound(t,e),(t=document.createElement("audio")).src=this.modelHomeDir+o,logger.trace("Start sound : "+o),t.play()),this.mainMotionManager.startMotionPrio(s,i)}setExpression(t){var e=this.expressions[t];logger.trace("Expression : "+t),this.expressionManager?.startMotion(e,!1)}draw(t){MatrixStack.push(),MatrixStack.multMatrix(this.modelMatrix.getArray()),this.tmpMatrix=MatrixStack.getMatrix(),this.live2DModel.setMatrix(this.tmpMatrix),this.live2DModel.draw(),MatrixStack.pop()}hitTest(e,i,s){var o,l=this.modelSetting.getHitAreaNum();if(0==l){var t=this.modelSetting.getHitAreaCustom();if(t){var a=t[e+"_x"],t=t[e+"_y"];if(i>Math.min(...a)&&i<Math.max(...a)&&s>Math.min(...t)&&s<Math.max(...t))return!0}}for(let t=0;t<l;t++)if(e==this.modelSetting.getHitAreaName(t))return o=this.modelSetting.getHitAreaID(t),this.hitTestSimple(o,i,s);return!1}}export default LAppModel;