import{l as t}from"../waifu-tips.js";class e{constructor(){this.live2DModel=null,this.modelMatrix=null,this.eyeBlink=null,this.physics=null,this.pose=null,this.initialized=!1,this.updating=!1,this.alpha=1,this.accAlpha=0,this.lipSync=!1,this.lipSyncValue=0,this.accelX=0,this.accelY=0,this.accelZ=0,this.dragX=0,this.dragY=0,this.startTimeMSec=null,this.mainMotionManager=new l,this.expressionManager=new l,this.motions={},this.expressions={},this.isTexLoaded=!1}getModelMatrix(){return this.modelMatrix}setAlpha(t){this.alpha=t=(t=.999<t?1:t)<.001?0:t}getAlpha(){return this.alpha}isInitialized(){return this.initialized}setInitialized(t){this.initialized=t}isUpdating(){return this.updating}setUpdating(t){this.updating=t}getLive2DModel(){return this.live2DModel}setLipSync(t){this.lipSync=t}setLipSyncValue(t){this.lipSyncValue=t}setAccel(t,e,i){this.accelX=t,this.accelY=e,this.accelZ=i}setDrag(t,e){this.dragX=t,this.dragY=e}getMainMotionManager(){return this.mainMotionManager}getExpressionManager(){return this.expressionManager}loadModelData(e,i){var s=M.getPlatformManager();t.info("Load model : "+e),s.loadLive2DModel(e,e=>{this.live2DModel=e,this.live2DModel.saveParam(),0==Live2D.getError()?(this.modelMatrix=new h(this.live2DModel.getCanvasWidth(),this.live2DModel.getCanvasHeight()),this.modelMatrix.setWidth(2),this.modelMatrix.setCenterPosition(0,0),i(this.live2DModel)):t.error("Error : Failed to loadModelData().")})}loadTexture(e,s,a){i++;var r=M.getPlatformManager();t.info("Load Texture : "+s),r.loadTexture(this.live2DModel,e,s,()=>{0==--i&&(this.isTexLoaded=!0),"function"==typeof a&&a()})}loadMotion(e,i,s){var a=M.getPlatformManager();t.trace("Load Motion : "+i);let r;a.loadBytes(i,t=>{r=Live2DMotion.loadMotion(t),null!=e&&(this.motions[e]=r),s(r)})}loadExpression(e,i,a){var r=M.getPlatformManager();t.trace("Load Expression : "+i),r.loadBytes(i,t=>{null!=e&&(this.expressions[e]=s.loadJson(t)),"function"==typeof a&&a()})}loadPose(e,i){var s=M.getPlatformManager();t.trace("Load Pose : "+e);try{s.loadBytes(e,t=>{this.pose=d.load(t),"function"==typeof i&&i()})}catch(e){t.warn(e)}}loadPhysics(e){var i=M.getPlatformManager();t.trace("Load Physics : "+e);try{i.loadBytes(e,t=>{this.physics=c.load(t)})}catch(e){t.warn(e)}}hitTestSimple(t,e,i){t=this.live2DModel.getDrawDataIndex(t);if(t<0)return!1;var s=this.live2DModel.getTransformedPoints(t);let a=this.live2DModel.getCanvasWidth(),r=0,n=this.live2DModel.getCanvasHeight(),h=0;for(let i=0;i<s.length;i+=2){let t=s[i],e=s[i+1];t<a&&(a=t),t>r&&(r=t),e<n&&(n=e),e>h&&(h=e)}t=this.modelMatrix.invertTransformX(e),e=this.modelMatrix.invertTransformY(i);return a<=t&&t<=r&&n<=e&&e<=h}}let i=0;class s extends AMotion{constructor(){super(),this.paramList=[]}static loadJson(t){let l=new s,e=M.getPlatformManager().jsonParseFromBytes(t);if(l.setFadeIn(0<parseInt(e.fade_in)?parseInt(e.fade_in):1e3),l.setFadeOut(0<parseInt(e.fade_out)?parseInt(e.fade_out):1e3),null!=e.params){let h=e.params,t=h.length;l.paramList=[];for(let r=0;r<t;r++){let e=h[r],t=e.id.toString(),i=parseFloat(e.val),a=void s.TYPE_ADD;var o=null!=e.calc?e.calc.toString():"add";if((a="add"===o?s.TYPE_ADD:"mult"===o?s.TYPE_MULT:"set"===o?s.TYPE_SET:s.TYPE_ADD)==s.TYPE_ADD)i-=null==e.def?0:parseFloat(e.def);else if(a==s.TYPE_MULT){let t=null==e.def?1:parseFloat(e.def);0==t&&(t=1),i/=t}o=new n;o.id=t,o.type=a,o.value=i,l.paramList.push(o)}}return l}updateParamExe(i,t,a,e){for(let e=this.paramList.length-1;0<=e;--e){let t=this.paramList[e];t.type==s.TYPE_ADD?i.addToParamFloat(t.id,t.value,a):t.type==s.TYPE_MULT?i.multParamFloat(t.id,t.value,a):t.type==s.TYPE_SET&&i.setParamFloat(t.id,t.value,a)}}}function n(){this.id="",this.type=-1,this.value=null}s.EXPRESSION_DEFAULT="DEFAULT",s.TYPE_SET=0,s.TYPE_ADD=1,s.TYPE_MULT=2;class a{constructor(){this.nextBlinkTime=null,this.stateStartTime=null,this.blinkIntervalMsec=null,this.eyeState=r.STATE_FIRST,this.blinkIntervalMsec=4e3,this.closingMotionMsec=100,this.closedMotionMsec=50,this.openingMotionMsec=150,this.closeIfZero=!0,this.eyeID_L="PARAM_EYE_L_OPEN",this.eyeID_R="PARAM_EYE_R_OPEN"}calcNextBlink(){return UtSystem.getUserTimeMSec()+Math.random()*(2*this.blinkIntervalMsec-1)}setInterval(t){this.blinkIntervalMsec=t}setEyeMotion(t,e,i){this.closingMotionMsec=t,this.closedMotionMsec=e,this.openingMotionMsec=i}updateParam(t){var e=UtSystem.getUserTimeMSec();let i,s=0;switch(this.eyeState){case r.STATE_CLOSING:1<=(s=(e-this.stateStartTime)/this.closingMotionMsec)&&(s=1,this.eyeState=r.STATE_CLOSED,this.stateStartTime=e),i=1-s;break;case r.STATE_CLOSED:1<=(s=(e-this.stateStartTime)/this.closedMotionMsec)&&(this.eyeState=r.STATE_OPENING,this.stateStartTime=e),i=0;break;case r.STATE_OPENING:1<=(s=(e-this.stateStartTime)/this.openingMotionMsec)&&(s=1,this.eyeState=r.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink()),i=s;break;case r.STATE_INTERVAL:this.nextBlinkTime<e&&(this.eyeState=r.STATE_CLOSING,this.stateStartTime=e),i=1;break;default:r.STATE_FIRST;this.eyeState=r.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink(),i=1}this.closeIfZero||(i=-i),t.setParamFloat(this.eyeID_L,i),t.setParamFloat(this.eyeID_R,i)}}let r=()=>{};r.STATE_FIRST="STATE_FIRST",r.STATE_INTERVAL="STATE_INTERVAL",r.STATE_CLOSING="STATE_CLOSING",r.STATE_CLOSED="STATE_CLOSED",r.STATE_OPENING="STATE_OPENING";class o{constructor(){this.tr=new Float32Array(16),this.identity()}static mul(t,e,i){var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let a,r,n;for(a=0;a<4;a++)for(r=0;r<4;r++)for(n=0;n<4;n++)s[a+4*r]+=t[a+4*n]*e[n+4*r];for(a=0;a<16;a++)i[a]=s[a]}identity(){for(let t=0;t<16;t++)this.tr[t]=t%5==0?1:0}getArray(){return this.tr}getCopyMatrix(){return new Float32Array(this.tr)}setMatrix(e){if(null!=this.tr&&this.tr.length==this.tr.length)for(let t=0;t<16;t++)this.tr[t]=e[t]}getScaleX(){return this.tr[0]}getScaleY(){return this.tr[5]}transformX(t){return this.tr[0]*t+this.tr[12]}transformY(t){return this.tr[5]*t+this.tr[13]}invertTransformX(t){return(t-this.tr[12])/this.tr[0]}invertTransformY(t){return(t-this.tr[13])/this.tr[5]}multTranslate(t,e){t=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];o.mul(t,this.tr,this.tr)}translate(t,e){this.tr[12]=t,this.tr[13]=e}translateX(t){this.tr[12]=t}translateY(t){this.tr[13]=t}multScale(t,e){t=[t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1];o.mul(t,this.tr,this.tr)}scale(t,e){this.tr[0]=t,this.tr[5]=e}}class h extends o{constructor(t,e){super(),this.width=t,this.height=e}setPosition(t,e){this.translate(t,e)}setCenterPosition(t,e){var i=this.width*this.getScaleX(),s=this.height*this.getScaleY();this.translate(t-i/2,e-s/2)}top(t){this.setY(t)}bottom(t){var e=this.height*this.getScaleY();this.translateY(t-e)}left(t){this.setX(t)}right(t){var e=this.width*this.getScaleX();this.translateX(t-e)}centerX(t){var e=this.width*this.getScaleX();this.translateX(t-e/2)}centerY(t){var e=this.height*this.getScaleY();this.translateY(t-e/2)}setX(t){this.translateX(t)}setY(t){this.translateY(t)}setHeight(t){t/=this.height;this.scale(t,-t)}setWidth(t){t/=this.width;this.scale(t,-t)}}class l extends MotionQueueManager{constructor(){super(),this.currentPriority=null,this.reservePriority=null,this.super=MotionQueueManager.prototype}getCurrentPriority(){return this.currentPriority}getReservePriority(){return this.reservePriority}reserveMotion(t){return!(this.reservePriority>=t||this.currentPriority>=t||(this.reservePriority=t,0))}setReservePriority(t){this.reservePriority=t}updateParam(t){t=MotionQueueManager.prototype.updateParam.call(this,t);return this.isFinished()&&(this.currentPriority=0),t}startMotionPrio(t,e){return e==this.reservePriority&&(this.reservePriority=0),this.currentPriority=e,this.startMotion(t,!1)}}class c{constructor(){this.physicsList=[],this.startTimeMSec=UtSystem.getUserTimeMSec()}static load(t){let o=new c,d=M.getPlatformManager().jsonParseFromBytes(t).physics_hair,e=d.length;for(let l=0;l<e;l++){let t=d[l],r=new PhysicsHair,e=t.setup,i=parseFloat(e.length),s=parseFloat(e.regist),a=parseFloat(e.mass),n=(r.setup(i,s,a),t.src),h=n.length;for(let a=0;a<h;a++){let t=n[a],e=t.id,i=PhysicsHair.Src.SRC_TO_X,s=t.ptype;"x"===s?i=PhysicsHair.Src.SRC_TO_X:"y"===s?i=PhysicsHair.Src.SRC_TO_Y:"angle"===s?i=PhysicsHair.Src.SRC_TO_G_ANGLE:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Src");var u=parseFloat(t.scale),m=parseFloat(t.weight);r.addSrcParam(i,e,u,m)}var g=t.targets,S=g.length;for(let a=0;a<S;a++){let t=g[a],e=t.id,i=PhysicsHair.Target.TARGET_FROM_ANGLE,s=t.ptype;"angle"===s?i=PhysicsHair.Target.TARGET_FROM_ANGLE:"angle_v"===s?i=PhysicsHair.Target.TARGET_FROM_ANGLE_V:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Target");var T=parseFloat(t.scale),p=parseFloat(t.weight);r.addTargetParam(i,e,T,p)}o.physicsList.push(r)}return o}updateParam(e){var i=UtSystem.getUserTimeMSec()-this.startTimeMSec;for(let t=0;t<this.physicsList.length;t++)this.physicsList[t].update(e,i)}}class d{constructor(){this.lastTime=0,this.lastModel=null,this.partsGroups=[]}static load(t){let i=new d,r=M.getPlatformManager().jsonParseFromBytes(t).parts_visible,s=r.length;for(let e=0;e<s;e++){let s=r[e].group,t=s.length,a=[];for(let e=0;e<t;e++){let t=s[e],i=new u(t.id);if(a[e]=i,null!=t.link){var n=t.link,h=n.length;i.link=[];for(let e=0;e<h;e++){let t=new u(n[e]);i.link.push(t)}}}i.partsGroups.push(a)}return i}updateParam(i){if(null!=i){i!=this.lastModel&&this.initParam(i),this.lastModel=i;var t=UtSystem.getUserTimeMSec();let e=0==this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,e<0&&(e=0);for(let t=0;t<this.partsGroups.length;t++)this.normalizePartsOpacityGroup(i,this.partsGroups[t],e),this.copyOpacityOtherParts(i,this.partsGroups[t])}}initParam(i){if(null!=i)for(let t=0;t<this.partsGroups.length;t++){var s=this.partsGroups[t];for(let e=0;e<s.length;e++){s[e].initIndex(i);var a=s[e].partsIndex,r=s[e].paramIndex;if(!(a<0)){var n=0!=i.getParamFloat(r);if(i.setPartsOpacity(a,n?1:0),i.setParamFloat(r,n?1:0),null!=s[e].link)for(let t=0;t<s[e].link.length;t++)s[e].link[t].initIndex(i)}}}}normalizePartsOpacityGroup(i,e,s){let a=-1,r=1;for(let t=0;t<e.length;t++){var n=e[t].partsIndex,h=e[t].paramIndex;if(!(n<0)&&0!=i.getParamFloat(h)){if(0<=a)break;a=t,r=i.getPartsOpacity(n),1<(r+=s/.5)&&(r=1)}}a<0&&(a=0,r=1);for(let t=0;t<e.length;t++){var l=e[t].partsIndex;if(!(l<0))if(a==t)i.setPartsOpacity(l,r);else{let t,e=i.getPartsOpacity(l);.15<(1-(t=r<.5?-.5*r/.5+1:.5*(1-r)/.5))*(1-r)&&(t=1-.15/(1-r)),e>t&&(e=t),i.setPartsOpacity(l,e)}}}copyOpacityOtherParts(e,i){for(let t=0;t<i.length;t++){var s=i[t];if(null!=s.link&&!(s.partsIndex<0)){var a=e.getPartsOpacity(s.partsIndex);for(let t=0;t<s.link.length;t++){var r=s.link[t];r.partsIndex<0||e.setPartsOpacity(r.partsIndex,a)}}}}}class u{constructor(t){this.paramIndex=-1,this.partsIndex=-1,this.link=null,this.id=t}initIndex(t){this.paramIndex=t.getParamIndex("VISIBLE:"+this.id),this.partsIndex=t.getPartsDataIndex(PartsDataID.getID(this.id)),t.setParamFloat(this.paramIndex,1)}}class m{constructor(){this.EPSILON=.01,this.faceTargetX=0,this.faceTargetY=0,this.faceX=0,this.faceY=0,this.faceVX=0,this.faceVY=0,this.lastTimeSec=0}setPoint(t,e){this.faceTargetX=t,this.faceTargetY=e}getX(){return this.faceX}getY(){return this.faceY}update(){let s=40/7.5/m.FRAME_RATE;if(0==this.lastTimeSec)this.lastTimeSec=UtSystem.getUserTimeMSec();else{let t=UtSystem.getUserTimeMSec(),e=(t-this.lastTimeSec)*m.FRAME_RATE/1e3;this.lastTimeSec=t;var a=e*s/(.15*m.FRAME_RATE),r=this.faceTargetX-this.faceX,n=this.faceTargetY-this.faceY;if(!(Math.abs(r)<=this.EPSILON&&Math.abs(n)<=this.EPSILON)){var h=Math.sqrt(r*r+n*n),n=s*n/h;let t=s*r/h-this.faceVX,e=n-this.faceVY,i=Math.sqrt(t*t+e*e);(i<-a||a<i)&&(t*=a/i,e*=a/i,0),this.faceVX+=t,this.faceVY+=e;{let t=.5*(Math.sqrt(a*a+16*a*h-8*a*h)-a),e=Math.sqrt(this.faceVX*this.faceVX+this.faceVY*this.faceVY);e>t&&(this.faceVX*=t/e,this.faceVY*=t/e)}this.faceX+=this.faceVX,this.faceY+=this.faceVY}}}}m.FRAME_RATE=30;class g extends o{constructor(){super(),this.screenLeft=null,this.screenRight=null,this.screenTop=null,this.screenBottom=null,this.maxLeft=null,this.maxRight=null,this.maxTop=null,this.maxBottom=null,this.max=Number.MAX_VALUE,this.min=0}getMaxScale(){return this.max}getMinScale(){return this.min}setMaxScale(t){this.max=t}setMinScale(t){this.min=t}isMaxScale(){return this.getScaleX()==this.max}isMinScale(){return this.getScaleX()==this.min}adjustTranslate(t,e){this.tr[0]*this.maxLeft+(this.tr[12]+t)>this.screenLeft&&(t=this.screenLeft-this.tr[0]*this.maxLeft-this.tr[12]),this.tr[0]*this.maxRight+(this.tr[12]+t)<this.screenRight&&(t=this.screenRight-this.tr[0]*this.maxRight-this.tr[12]),this.tr[5]*this.maxTop+(this.tr[13]+e)<this.screenTop&&(e=this.screenTop-this.tr[5]*this.maxTop-this.tr[13]);t=[1,0,0,0,0,1,0,0,0,0,1,0,t,e=this.tr[5]*this.maxBottom+(this.tr[13]+e)>this.screenBottom?this.screenBottom-this.tr[5]*this.maxBottom-this.tr[13]:e,0,1];o.mul(t,this.tr,this.tr)}adjustScale(t,e,i){var s=i*this.tr[0],s=(s<this.min?0<this.tr[0]&&(i=this.min/this.tr[0]):s>this.max&&0<this.tr[0]&&(i=this.max/this.tr[0]),[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]),i=[i,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1],t=[1,0,0,0,0,1,0,0,0,0,1,0,-t,-e,0,1];o.mul(t,this.tr,this.tr),o.mul(i,this.tr,this.tr),o.mul(s,this.tr,this.tr)}setScreenRect(t,e,i,s){this.screenLeft=t,this.screenRight=e,this.screenTop=s,this.screenBottom=i}setMaxScreenRect(t,e,i,s){this.maxLeft=t,this.maxRight=e,this.maxTop=s,this.maxBottom=i}getScreenLeft(){return this.screenLeft}getScreenRight(){return this.screenRight}getScreenBottom(){return this.screenBottom}getScreenTop(){return this.screenTop}getMaxLeft(){return this.maxLeft}getMaxRight(){return this.maxRight}getMaxBottom(){return this.maxBottom}getMaxTop(){return this.maxTop}}class M{static getPlatformManager(){return M.platformManager}static setPlatformManager(t){M.platformManager=t}}M.platformManager=null;let S=1.5,T=1,p=-1,E=1,v=-2,P=2,_=-2,I=2,x=1,f=2,A=3,y="idle",R="tap_body",O="pinch_in",D="pinch_out",L="head",N="body";class w{static reset(){this.depth=0}static loadIdentity(){for(let t=0;t<16;t++)this.currentMatrix[t]=t%5==0?1:0}static push(){this.depth;var e=16*(this.depth+1);this.matrixStack.length<16+e&&(this.matrixStack.length=16+e);for(let t=0;t<16;t++)this.matrixStack[e+t]=this.currentMatrix[t];this.depth++}static pop(){this.depth--,this.depth<0&&(this.depth=0);var e=16*this.depth;for(let t=0;t<16;t++)this.currentMatrix[t]=this.matrixStack[e+t]}static getMatrix(){return this.currentMatrix}static multMatrix(t){let e,i,s;for(e=0;e<16;e++)this.tmp[e]=0;for(e=0;e<4;e++)for(i=0;i<4;i++)for(s=0;s<4;s++)this.tmp[e+4*i]+=this.currentMatrix[e+4*s]*t[s+4*i];for(e=0;e<16;e++)this.currentMatrix[e]=this.tmp[e]}}w.matrixStack=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],w.depth=0,w.currentMatrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],w.tmp=new Array(16);class F{constructor(){this.NAME="name",this.ID="id",this.MODEL="model",this.TEXTURES="textures",this.HIT_AREAS="hit_areas",this.HIT_AREAS_CUSTOM="hit_areas_custom",this.PHYSICS="physics",this.POSE="pose",this.EXPRESSIONS="expressions",this.MOTION_GROUPS="motions",this.SOUND="sound",this.FADE_IN="fade_in",this.FADE_OUT="fade_out",this.LAYOUT="layout",this.INIT_PARAM="init_param",this.INIT_PARTS_VISIBLE="init_parts_visible",this.VALUE="val",this.FILE="file",this.json={}}loadModelSetting(t,e){M.getPlatformManager().loadBytes(t,t=>{t=String.fromCharCode.apply(null,new Uint8Array(t));this.json=JSON.parse(t),e()})}getTextureFile(t){return null==this.json[this.TEXTURES]||null==this.json[this.TEXTURES][t]?null:this.json[this.TEXTURES][t]}getModelFile(){return this.json[this.MODEL]}getTextureNum(){return null==this.json[this.TEXTURES]?0:this.json[this.TEXTURES].length}getHitAreaNum(){return null==this.json[this.HIT_AREAS]?0:this.json[this.HIT_AREAS].length}getHitAreaCustom(){return this.json[this.HIT_AREAS_CUSTOM]}getHitAreaID(t){return null==this.json[this.HIT_AREAS]||null==this.json[this.HIT_AREAS][t]?null:this.json[this.HIT_AREAS][t][this.ID]}getHitAreaName(t){return null==this.json[this.HIT_AREAS]||null==this.json[this.HIT_AREAS][t]?null:this.json[this.HIT_AREAS][t][this.NAME]}getPhysicsFile(){return this.json[this.PHYSICS]}getPoseFile(){return this.json[this.POSE]}getExpressionNum(){return null==this.json[this.EXPRESSIONS]?0:this.json[this.EXPRESSIONS].length}getExpressionFile(t){return null==this.json[this.EXPRESSIONS]?null:this.json[this.EXPRESSIONS][t][this.FILE]}getExpressionName(t){return null==this.json[this.EXPRESSIONS]?null:this.json[this.EXPRESSIONS][t][this.NAME]}getLayout(){return this.json[this.LAYOUT]}getInitParamNum(){return null==this.json[this.INIT_PARAM]?0:this.json[this.INIT_PARAM].length}getMotionNum(t){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]?0:this.json[this.MOTION_GROUPS][t].length}getMotionFile(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]?null:this.json[this.MOTION_GROUPS][t][e][this.FILE]}getMotionSound(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]||null==this.json[this.MOTION_GROUPS][t][e][this.SOUND]?null:this.json[this.MOTION_GROUPS][t][e][this.SOUND]}getMotionFadeIn(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]||null==this.json[this.MOTION_GROUPS][t][e][this.FADE_IN]?1e3:this.json[this.MOTION_GROUPS][t][e][this.FADE_IN]}getMotionFadeOut(t,e){return null==this.json[this.MOTION_GROUPS]||null==this.json[this.MOTION_GROUPS][t]||null==this.json[this.MOTION_GROUPS][t][e]||null==this.json[this.MOTION_GROUPS][t][e][this.FADE_OUT]?1e3:this.json[this.MOTION_GROUPS][t][e][this.FADE_OUT]}getInitParamID(t){return null==this.json[this.INIT_PARAM]||null==this.json[this.INIT_PARAM][t]?null:this.json[this.INIT_PARAM][t][this.ID]}getInitParamValue(t){return null==this.json[this.INIT_PARAM]||null==this.json[this.INIT_PARAM][t]?NaN:this.json[this.INIT_PARAM][t][this.VALUE]}getInitPartsVisibleNum(){return null==this.json[this.INIT_PARTS_VISIBLE]?0:this.json[this.INIT_PARTS_VISIBLE].length}getInitPartsVisibleID(t){return null==this.json[this.INIT_PARTS_VISIBLE]||null==this.json[this.INIT_PARTS_VISIBLE][t]?null:this.json[this.INIT_PARTS_VISIBLE][t][this.ID]}getInitPartsVisibleValue(t){return null==this.json[this.INIT_PARTS_VISIBLE]||null==this.json[this.INIT_PARTS_VISIBLE][t]?NaN:this.json[this.INIT_PARTS_VISIBLE][t][this.VALUE]}}class U extends e{constructor(){super(),this.modelHomeDir="",this.modelSetting=null,this.tmpMatrix=[]}loadJSON(s){var t=this.modelHomeDir+this.modelSetting.getModelFile();this.loadModelData(t,t=>{for(let t=0;t<this.modelSetting.getTextureNum();t++){var e=this.modelHomeDir+this.modelSetting.getTextureFile(t);this.loadTexture(t,e,()=>{if(this.isTexLoaded){if(0<this.modelSetting.getExpressionNum()){this.expressions={};for(let t=0;t<this.modelSetting.getExpressionNum();t++){var e=this.modelSetting.getExpressionName(t),i=this.modelHomeDir+this.modelSetting.getExpressionFile(t);this.loadExpression(e,i)}}else this.expressionManager=null,this.expressions={};if(null==this.eyeBlink&&(this.eyeBlink=new a),null!=this.modelSetting.getPhysicsFile()?this.loadPhysics(this.modelHomeDir+this.modelSetting.getPhysicsFile()):this.physics=null,null!=this.modelSetting.getPoseFile()?this.loadPose(this.modelHomeDir+this.modelSetting.getPoseFile(),()=>{this.pose.updateParam(this.live2DModel)}):this.pose=null,null!=this.modelSetting.getLayout()){let t=this.modelSetting.getLayout();null!=t.width&&this.modelMatrix.setWidth(t.width),null!=t.height&&this.modelMatrix.setHeight(t.height),null!=t.x&&this.modelMatrix.setX(t.x),null!=t.y&&this.modelMatrix.setY(t.y),null!=t.center_x&&this.modelMatrix.centerX(t.center_x),null!=t.center_y&&this.modelMatrix.centerY(t.center_y),null!=t.top&&this.modelMatrix.top(t.top),null!=t.bottom&&this.modelMatrix.bottom(t.bottom),null!=t.left&&this.modelMatrix.left(t.left),null!=t.right&&this.modelMatrix.right(t.right)}for(let t=0;t<this.modelSetting.getInitParamNum();t++)this.live2DModel.setParamFloat(this.modelSetting.getInitParamID(t),this.modelSetting.getInitParamValue(t));for(let t=0;t<this.modelSetting.getInitPartsVisibleNum();t++)this.live2DModel.setPartsOpacity(this.modelSetting.getInitPartsVisibleID(t),this.modelSetting.getInitPartsVisibleValue(t));this.live2DModel.saveParam(),this.preloadMotionGroup(y),this.mainMotionManager.stopAllMotions(),this.setUpdating(!1),this.setInitialized(!0),"function"==typeof s&&s()}})}})}async loadModelSetting(t,e){this.setUpdating(!0),this.setInitialized(!1),this.modelHomeDir=t.substring(0,t.lastIndexOf("/")+1),this.modelSetting=new F,this.modelSetting.json=e,await new Promise(t=>this.loadJSON(t))}load(t,e,i){this.setUpdating(!0),this.setInitialized(!1),this.modelHomeDir=e.substring(0,e.lastIndexOf("/")+1),this.modelSetting=new F,this.modelSetting.loadModelSetting(e,()=>{this.loadJSON(i)})}release(t){var e=M.getPlatformManager();t.deleteTexture(e.texture)}preloadMotionGroup(i){for(let e=0;e<this.modelSetting.getMotionNum(i);e++){var t=this.modelSetting.getMotionFile(i,e);this.loadMotion(t,this.modelHomeDir+t,t=>{t.setFadeIn(this.modelSetting.getMotionFadeIn(i,e)),t.setFadeOut(this.modelSetting.getMotionFadeOut(i,e))})}}update(){var e;null==this.live2DModel?t.error("Failed to update."):(e=(UtSystem.getUserTimeMSec()-this.startTimeMSec)/1e3*2*Math.PI,this.mainMotionManager.isFinished()&&this.startRandomMotion(y,x),this.live2DModel.loadParam(),this.mainMotionManager.updateParam(this.live2DModel)||null!=this.eyeBlink&&this.eyeBlink.updateParam(this.live2DModel),this.live2DModel.saveParam(),null==this.expressionManager||null==this.expressions||this.expressionManager.isFinished()||this.expressionManager.updateParam(this.live2DModel),this.live2DModel.addToParamFloat("PARAM_ANGLE_X",30*this.dragX,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",30*this.dragY,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",this.dragX*this.dragY*-30,1),this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",10*this.dragX,1),this.live2DModel.addToParamFloat("PARAM_EYE_BALL_X",this.dragX,1),this.live2DModel.addToParamFloat("PARAM_EYE_BALL_Y",this.dragY,1),this.live2DModel.addToParamFloat("PARAM_ANGLE_X",Number(15*Math.sin(e/6.5345)),.5),this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",Number(8*Math.sin(e/3.5345)),.5),this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",Number(10*Math.sin(e/5.5345)),.5),this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",Number(4*Math.sin(e/15.5345)),.5),this.live2DModel.setParamFloat("PARAM_BREATH",Number(.5+.5*Math.sin(e/3.2345)),1),null!=this.physics&&this.physics.updateParam(this.live2DModel),null==this.lipSync&&this.live2DModel.setParamFloat("PARAM_MOUTH_OPEN_Y",this.lipSyncValue),null!=this.pose&&this.pose.updateParam(this.live2DModel),this.live2DModel.update())}setRandomExpression(){var e=[];for(let t in this.expressions)e.push(t);let t=parseInt(Math.random()*e.length);this.setExpression(e[t])}startRandomMotion(t,e){var i=this.modelSetting.getMotionNum(t),i=parseInt(Math.random()*i);this.startMotion(t,i,e)}startMotion(i,s,a){var r=this.modelSetting.getMotionFile(i,s);if(null!=r&&""!=r){if(a==A)this.mainMotionManager.setReservePriority(a);else if(!this.mainMotionManager.reserveMotion(a))return void t.trace("Motion is running.");let e;null==this.motions[i]?this.loadMotion(null,this.modelHomeDir+r,t=>{e=t,this.setFadeInFadeOut(i,s,a,e)}):(e=this.motions[i],this.setFadeInFadeOut(i,s,a,e))}}setFadeInFadeOut(s,a,e,i){let r=this.modelSetting.getMotionFile(s,a);if(i.setFadeIn(this.modelSetting.getMotionFadeIn(s,a)),i.setFadeOut(this.modelSetting.getMotionFadeOut(s,a)),t.trace("Start motion : "+r),null!=this.modelSetting.getMotionSound(s,a)){let e=this.modelSetting.getMotionSound(s,a),i=document.createElement("audio");i.src=this.modelHomeDir+e,t.trace("Start sound : "+e),i.play()}this.mainMotionManager.startMotionPrio(i,e)}setExpression(e){var i=this.expressions[e];t.trace("Expression : "+e),null!=(e=this.expressionManager)&&e.startMotion(i,!1)}draw(t){w.push(),w.multMatrix(this.modelMatrix.getArray()),this.tmpMatrix=w.getMatrix(),this.live2DModel.setMatrix(this.tmpMatrix),this.live2DModel.draw(),w.pop()}hitTest(i,s,a){let t=this.modelSetting.getHitAreaNum();if(0==t){let t=this.modelSetting.getHitAreaCustom();if(t){var e=t[i+"_x"],r=t[i+"_y"];if(s>Math.min(...e)&&s<Math.max(...e)&&a>Math.min(...r)&&a<Math.max(...r))return!0}}for(let e=0;e<t;e++)if(i==this.modelSetting.getHitAreaName(e)){let t=this.modelSetting.getHitAreaID(e);return this.hitTestSimple(t,s,a)}return!1}}class X{constructor(){this.cache={}}loadBytes(e,i){if(e in this.cache)return i(this.cache[e]);fetch(e).then(t=>t.arrayBuffer()).then(t=>{this.cache[e]=t,i(t)})}loadLive2DModel(t,e){let i;this.loadBytes(t,t=>{i=Live2DModelWebGL.loadModel(t),e(i)})}loadTexture(s,a,e,r){let n=new Image;n.crossOrigin="anonymous",n.src=e,n.onload=()=>{var e=document.getElementById("live2d").getContext("webgl2",{premultipliedAlpha:!0,preserveDrawingBuffer:!0}),i=e.createTexture();if(!i)return t.error("Failed to generate gl texture name."),-1;0==s.isPremultipliedAlpha()&&e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.generateMipmap(e.TEXTURE_2D),s.setTexture(a,i),"function"==typeof r&&r()},n.onerror=()=>{t.error("Failed to load image : "+e)}}jsonParseFromBytes(t){var e=new Uint8Array(t,0,3),e=239==e[0]&&187==e[1]&&191==e[2]?String.fromCharCode.apply(null,new Uint8Array(t,3)):String.fromCharCode.apply(null,new Uint8Array(t));return JSON.parse(e)}}class Y{constructor(){this.model=null,this.reloading=!1,Live2D.init(),M.setPlatformManager(new X)}getModel(){return this.model}releaseModel(t){this.model&&(this.model.release(t),this.model=null)}async changeModel(s,a){return new Promise((i,t)=>{if(!this.reloading){this.reloading=!0;let t=this.model,e=new U;e.load(s,a,()=>{t&&t.release(s),this.model=e,this.reloading=!1,i()})}})}async changeModelWithJSON(t,e,i){var s,a;this.reloading||(this.reloading=!0,s=this.model,await(a=new U).loadModelSetting(e,i),s&&s.release(t),this.model=a,this.reloading=!1)}setDrag(t,e){this.model&&this.model.setDrag(t,e)}maxScaleEvent(){t.trace("Max scale event."),this.model&&this.model.startRandomMotion(O,f)}minScaleEvent(){t.trace("Min scale event."),this.model&&this.model.startRandomMotion(D,f)}tapEvent(e,i){return t.trace("tapEvent view x:"+e+" y:"+i),!!this.model&&(this.model.hitTest(L,e,i)?(t.trace("Tap face."),this.model.setRandomExpression()):this.model.hitTest(N,e,i)&&(t.trace("Tap body."),this.model.startRandomMotion(R,f)),!0)}}function j(t,e,i,s,a,r){t-=i,e-=s;return{vx:0<=t?t/(a-i):t/i,vy:-(0<=e?e/(r-s):e/s)}}class G{constructor(){this.live2DMgr=new Y,this.isDrawStart=!1,this.gl=null,this.canvas=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null,this.oldLen=0,this._boundMouseEvent=this.mouseEvent.bind(this),this._boundTouchEvent=this.touchEvent.bind(this)}initL2dCanvas(t){this.canvas=document.getElementById(t),this.canvas.addEventListener&&(this.canvas.addEventListener("mousewheel",this._boundMouseEvent,!1),this.canvas.addEventListener("click",this._boundMouseEvent,!1),document.addEventListener("mousemove",this._boundMouseEvent,!1),document.addEventListener("mouseout",this._boundMouseEvent,!1),this.canvas.addEventListener("contextmenu",this._boundMouseEvent,!1),this.canvas.addEventListener("touchstart",this._boundTouchEvent,!1),this.canvas.addEventListener("touchend",this._boundTouchEvent,!1),this.canvas.addEventListener("touchmove",this._boundTouchEvent,!1))}async init(e,i,s){this.initL2dCanvas(e);var e=this.canvas.width,a=this.canvas.height,r=(this.dragMgr=new m,a/e),n=p,h=E,l=-r;this.viewMatrix=new g,this.viewMatrix.setScreenRect(n,h,l,r),this.viewMatrix.setMaxScreenRect(v,P,_,I),this.viewMatrix.setMaxScale(S),this.viewMatrix.setMinScale(T),this.projMatrix=new o,this.projMatrix.multScale(1,e/a),this.deviceToScreen=new o,this.deviceToScreen.multTranslate(-e/2,-a/2),this.deviceToScreen.multScale(2/e,-2/e),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!0,preserveDrawingBuffer:!0}),this.gl?(Live2D.setGL(this.gl),this.gl.clearColor(0,0,0,0),await this.changeModelWithJSON(i,s),this.startDraw()):t.error("Failed to create WebGL context.")}destroy(){this.canvas&&(this.canvas.removeEventListener("mousewheel",this._boundMouseEvent,!1),this.canvas.removeEventListener("click",this._boundMouseEvent,!1),document.removeEventListener("mousemove",this._boundMouseEvent,!1),document.removeEventListener("mouseout",this._boundMouseEvent,!1),this.canvas.removeEventListener("contextmenu",this._boundMouseEvent,!1),this.canvas.removeEventListener("touchstart",this._boundTouchEvent,!1),this.canvas.removeEventListener("touchend",this._boundTouchEvent,!1),this.canvas.removeEventListener("touchmove",this._boundTouchEvent,!1)),this._drawFrameId&&(window.cancelAnimationFrame(this._drawFrameId),this._drawFrameId=null),this.isDrawStart=!1,this.live2DMgr&&"function"==typeof this.live2DMgr.release&&this.live2DMgr.release(),this.gl,this.canvas=null,this.gl=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null}startDraw(){if(!this.isDrawStart){this.isDrawStart=!0;let t=()=>{this.draw(),this._drawFrameId=window.requestAnimationFrame(t,this.canvas)};t()}}draw(){w.reset(),w.loadIdentity(),this.dragMgr.update(),this.live2DMgr.setDrag(this.dragMgr.getX(),this.dragMgr.getY()),this.gl.clear(this.gl.COLOR_BUFFER_BIT),w.multMatrix(this.projMatrix.getArray()),w.multMatrix(this.viewMatrix.getArray()),w.push();var t=this.live2DMgr.getModel();null!=t&&(t.initialized&&!t.updating&&(t.update(),t.draw(this.gl)),w.pop())}async changeModel(t){await this.live2DMgr.changeModel(this.gl,t)}async changeModelWithJSON(t,e){await this.live2DMgr.changeModelWithJSON(this.gl,t,e)}modelScaling(t){var e=this.viewMatrix.isMaxScale(),i=this.viewMatrix.isMinScale();this.viewMatrix.adjustScale(0,0,t),e||this.viewMatrix.isMaxScale()&&this.live2DMgr.maxScaleEvent(),i||this.viewMatrix.isMinScale()&&this.live2DMgr.minScaleEvent()}modelTurnHead(e){var i=this.canvas.getBoundingClientRect(),{vx:i,vy:s}=j(e.clientX,e.clientY,i.left+i.width/2,i.top+i.height/2,window.innerWidth,window.innerHeight);t.trace("onMouseDown device( x:"+e.clientX+" y:"+e.clientY+" ) view( x:"+i+" y:"+s+")"),this.dragMgr.setPoint(i,s),this.live2DMgr.tapEvent(i,s),null!=(e=this.live2DMgr)&&e.model.hitTest(N,i,s)&&window.dispatchEvent(new Event("live2d:tapbody"))}followPointer(e){var i=this.canvas.getBoundingClientRect(),{vx:i,vy:s}=j(e.clientX,e.clientY,i.left+i.width/2,i.top+i.height/2,window.innerWidth,window.innerHeight);t.trace("onMouseMove device( x:"+e.clientX+" y:"+e.clientY+" ) view( x:"+i+" y:"+s+")"),this.dragMgr.setPoint(i,s),null!=(e=this.live2DMgr)&&e.model.hitTest(N,i,s)&&window.dispatchEvent(new Event("live2d:hoverbody"))}lookFront(){this.dragMgr.setPoint(0,0)}mouseEvent(t){t.preventDefault(),"mousewheel"==t.type?0<t.wheelDelta?this.modelScaling(1.1):this.modelScaling(.9):"click"==t.type||"contextmenu"==t.type?this.modelTurnHead(t):"mousemove"==t.type?this.followPointer(t):"mouseout"==t.type&&this.lookFront()}touchEvent(s){s.preventDefault();let t=s.touches[0];if("touchstart"==s.type)1==s.touches.length&&this.modelTurnHead(t);else if("touchmove"==s.type){if(this.followPointer(t),2==s.touches.length){let t=s.touches[0],e=s.touches[1],i=Math.pow(t.pageX-e.pageX,2)+Math.pow(t.pageY-e.pageY,2);this.oldLen-i<0?this.modelScaling(1.025):this.modelScaling(.975),this.oldLen=i}}else"touchend"==s.type&&this.lookFront()}transformViewX(t){t=this.deviceToScreen.transformX(t);return this.viewMatrix.invertTransformX(t)}transformViewY(t){t=this.deviceToScreen.transformY(t);return this.viewMatrix.invertTransformY(t)}transformScreenX(t){return this.deviceToScreen.transformX(t)}transformScreenY(t){return this.deviceToScreen.transformY(t)}}export{G as default};