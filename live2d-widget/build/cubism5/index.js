import{LAppDelegate}from"@demo/lappdelegate.js";import{LAppSubdelegate}from"@demo/lappsubdelegate.js";import*as LAppDefine from"@demo/lappdefine.js";import{LAppModel}from"@demo/lappmodel.js";import{LAppPal}from"@demo/lapppal";import logger from"../logger.js";LAppPal.printMessage=()=>{};class AppSubdelegate extends LAppSubdelegate{initialize(e){if(!this._glManager.initialize(e))return!1;this._canvas=e,"auto"===LAppDefine.CanvasSize?this.resizeCanvas():(e.width=LAppDefine.CanvasSize.width,e.height=LAppDefine.CanvasSize.height),this._textureManager.setGlManager(this._glManager);e=this._glManager.getGl();return this._frameBuffer||(this._frameBuffer=e.getParameter(e.FRAMEBUFFER_BINDING)),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this._view.initialize(this),this._view._gear={render:()=>{},isHit:()=>{},release:()=>{}},this._view._back={render:()=>{},release:()=>{}},(this._live2dManager._subdelegate=this)._resizeObserver=new window.ResizeObserver((e,t)=>this.resizeObserverCallback.call(this,e,t)),this._resizeObserver.observe(this._canvas),!0}onResize(){this.resizeCanvas(),this._view.initialize(this)}update(){var e;this._glManager.getGl().isContextLost()||(this._needResize&&(this.onResize(),this._needResize=!1),(e=this._glManager.getGl()).clearColor(0,0,0,0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this._view.render())}}class AppDelegate extends LAppDelegate{run(){let e=()=>{LAppPal.updateTime();for(let e=0;e<this._subdelegates.getSize();e++)this._subdelegates.at(e).update();this._drawFrameId=window.requestAnimationFrame(e)};e()}stop(){this._drawFrameId&&(window.cancelAnimationFrame(this._drawFrameId),this._drawFrameId=null)}release(){this.stop(),this.releaseEventListener(),this._subdelegates.clear(),this._cubismOption=null}transformOffset(e){var t=this._subdelegates.at(0),s=t.getCanvas().getBoundingClientRect(),i=(e.pageX-s.left)*window.devicePixelRatio,e=(e.pageY-s.top)*window.devicePixelRatio;return{x:t._view.transformViewX(i),y:t._view.transformViewY(e)}}onMouseMove(e){var t=this._subdelegates.at(0).getLive2DManager(),{x:e,y:s}=this.transformOffset(e),i=t._models.at(0);t.onDrag(e,s),t.onTap(e,s),i.hitTest(LAppDefine.HitAreaNameBody,e,s)&&window.dispatchEvent(new Event("live2d:hoverbody"))}onMouseEnd(e){var t=this._subdelegates.at(0).getLive2DManager(),{x:e,y:s}=this.transformOffset(e);t.onDrag(0,0),t.onTap(e,s)}onTap(e){var t=this._subdelegates.at(0).getLive2DManager(),{x:e,y:s}=this.transformOffset(e);t._models.at(0).hitTest(LAppDefine.HitAreaNameBody,e,s)&&window.dispatchEvent(new Event("live2d:tapbody"))}initializeEventListener(){this.mouseMoveEventListener=this.onMouseMove.bind(this),this.mouseEndedEventListener=this.onMouseEnd.bind(this),this.tapEventListener=this.onTap.bind(this),document.addEventListener("mousemove",this.mouseMoveEventListener,{passive:!0}),document.addEventListener("mouseout",this.mouseEndedEventListener,{passive:!0}),document.addEventListener("pointerdown",this.tapEventListener,{passive:!0})}releaseEventListener(){document.removeEventListener("mousemove",this.mouseMoveEventListener,{passive:!0}),this.mouseMoveEventListener=null,document.removeEventListener("mouseout",this.mouseEndedEventListener,{passive:!0}),this.mouseEndedEventListener=null,document.removeEventListener("pointerdown",this.tapEventListener,{passive:!0})}initializeSubdelegates(){this._canvases.prepareCapacity(LAppDefine.CanvasNum),this._subdelegates.prepareCapacity(LAppDefine.CanvasNum);var e=document.getElementById("live2d");this._canvases.pushBack(e),e.style.width=e.width,e.style.height=e.height;for(let e=0;e<this._canvases.getSize();e++){var t=new AppSubdelegate;if(!t.initialize(this._canvases.at(e)))return void logger.error("Failed to initialize AppSubdelegate");this._subdelegates.pushBack(t)}for(let e=0;e<LAppDefine.CanvasNum;e++)this._subdelegates.at(e).isContextLost()&&logger.error(`The context for Canvas at index ${e} was lost, possibly because the acquisition limit for WebGLRenderingContext was reached.`)}changeModel(e){var e=e.split("/"),t=e.pop(),e=e.join("/")+"/",s=this._subdelegates.at(0).getLive2DManager(),i=(s.releaseAllModel(),new LAppModel);i.setSubdelegate(s._subdelegate),i.loadAssets(e,t),s._models.pushBack(i)}get subdelegates(){return this._subdelegates}}export{AppDelegate};