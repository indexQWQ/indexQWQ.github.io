import{showMessage}from"./message.js";import{loadExternalResource,randomOtherOption}from"./utils.js";import logger from"./logger.js";class ModelManager{constructor(e,t=[]){this.modelList=null;let{apiPath:s,cdnPath:i}=e;var{cubism2Path:d,cubism5Path:o}=e;let l=!1;if("string"==typeof i)i.endsWith("/")||(i+="/"),l=!0;else if("string"==typeof s)s.endsWith("/")||(s+="/"),i=s,l=!0,logger.warn("apiPath选项已弃用，请使用cdnPath代替");else if(!t.length)throw"初始化参数无效！";let a=parseInt(localStorage.getItem("modelId"),10),h=parseInt(localStorage.getItem("modelTexturesId"),10);(isNaN(a)||isNaN(h))&&(h=0),isNaN(a)&&(a=null!=(e=e.modelId)?e:0),this.useCDN=l,this.cdnPath=i||"",this.cubism2Path=d||"",this.cubism5Path=o||"",this._modelId=a,this._modelTexturesId=h,this.currentModelVersion=0,this.loading=!1,this.modelJSONCache={},this.models=t}static async initCheck(e,t=[]){var s,e=new ModelManager(e,t);return e.useCDN?(t=await fetch(e.cdnPath+"model_list.json"),e.modelList=await t.json(),e.modelId>=e.modelList.models.length&&(e.modelId=0),t=e.modelList.models[e.modelId],Array.isArray(t)?e.modelTexturesId>=t.length&&(e.modelTexturesId=0):(s=e.cdnPath+`model/${t}/index.json`,s=await e.fetchWithCache(s),2===e.checkModelVersion(s)&&(s=await e.loadTextureCache(t),e.modelTexturesId>=s.length)&&(e.modelTexturesId=0))):(e.modelId>=e.models.length&&(e.modelId=0),e.modelTexturesId>=e.models[e.modelId].paths.length&&(e.modelTexturesId=0)),e}set modelId(e){this._modelId=e,localStorage.setItem("modelId",e.toString())}get modelId(){return this._modelId}set modelTexturesId(e){this._modelTexturesId=e,localStorage.setItem("modelTexturesId",e.toString())}get modelTexturesId(){return this._modelTexturesId}resetCanvas(){document.getElementById("waifu-canvas").innerHTML='<canvas id="live2d" width="800" height="800"></canvas>'}async fetchWithCache(e){let t;if(e in this.modelJSONCache)t=this.modelJSONCache[e];else{try{var s=await fetch(e);t=await s.json()}catch(e){t=null}this.modelJSONCache[e]=t}return t}checkModelVersion(e){return 3===e.Version||e.FileReferences?3:2}async loadLive2D(e,t){if(this.loading)logger.warn("仍在加载中，中止操作");else{this.loading=!0;try{var s=this.checkModelVersion(t);if(2===s){if(!this.cubism2model){if(!this.cubism2Path)return void logger.error("未设置cubism2Path，无法加载Cubism 2核心库");await loadExternalResource(this.cubism2Path,"js");var i=(await import("./cubism2/index.js")).default;this.cubism2model=new i}3===this.currentModelVersion&&(this.cubism5model.release(),this.resetCanvas()),3!==this.currentModelVersion&&this.cubism2model.gl?await this.cubism2model.changeModelWithJSON(e,t):await this.cubism2model.init("live2d",e,t)}else{if(!this.cubism5Path)return void logger.error("未设置cubism5Path，无法加载Cubism 5核心库");await loadExternalResource(this.cubism5Path,"js");var d=(await import("./cubism5/index.js")).AppDelegate;this.cubism5model=new d,2===this.currentModelVersion&&(this.cubism2model.destroy(),this.resetCanvas()),2!==this.currentModelVersion&&this.cubism5model.subdelegates.at(0)?this.cubism5model.changeModel(e):(this.cubism5model.changeModel(e),this.cubism5model.run())}logger.info(`模型 ${e} (Cubism版本 ${s}) 加载成功`),this.currentModelVersion=s}catch(e){console.error("loadLive2D失败",e)}this.loading=!1}}async loadTextureCache(e){return await this.fetchWithCache(this.cdnPath+`model/${e}/textures.cache`)||[]}async loadModel(e){let t,s;if(this.useCDN){let e=this.modelList.models[this.modelId];if(Array.isArray(e)&&(e=e[this.modelTexturesId]),t=`${this.cdnPath}model/${e}/index.json`,s=await this.fetchWithCache(t),2===this.checkModelVersion(s)){var i=await this.loadTextureCache(e);if(0<i.length){let e=i[this.modelTexturesId];"string"==typeof e&&(e=[e]),s.textures=e}}}else t=this.models[this.modelId].paths[this.modelTexturesId],s=await this.fetchWithCache(t);await this.loadLive2D(t,s),showMessage(e,4e3,10)}async loadRandTexture(e="",t=""){var s,i,d=this.modelId;let o=!1;this.useCDN?(s=this.modelList.models[d],Array.isArray(s)?this.modelTexturesId=randomOtherOption(s.length,this.modelTexturesId):(i=this.cdnPath+`model/${s}/index.json`,i=await this.fetchWithCache(i),2!==this.checkModelVersion(i)||(i=await this.loadTextureCache(s)).length<=1?o=!0:this.modelTexturesId=randomOtherOption(i.length,this.modelTexturesId))):1===this.models[d].paths.length?o=!0:this.modelTexturesId=randomOtherOption(this.models[d].paths.length,this.modelTexturesId),o?showMessage(t,4e3,10):await this.loadModel(e)}async loadNextModel(){this.modelTexturesId=0,this.useCDN?(this.modelId=(this.modelId+1)%this.modelList.models.length,await this.loadModel(this.modelList.messages[this.modelId])):(this.modelId=(this.modelId+1)%this.models.length,await this.loadModel(this.models[this.modelId].message))}}export{ModelManager};