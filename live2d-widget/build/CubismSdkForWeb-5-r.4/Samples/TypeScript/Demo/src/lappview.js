import{CubismMatrix44}from"@framework/math/cubismmatrix44";import{CubismViewMatrix}from"@framework/math/cubismviewmatrix";import*as LAppDefine from"./lappdefine";import{LAppPal}from"./lapppal";import{LAppSprite}from"./lappsprite";import{TouchManager}from"./touchmanager";class LAppView{constructor(){this._programId=null,this._back=null,this._gear=null,this._touchManager=new TouchManager,this._deviceToScreen=new CubismMatrix44,this._viewMatrix=new CubismViewMatrix}initialize(e){var{width:e,height:i}=(this._subdelegate=e).getCanvas(),t=e/i,a=-t,r=LAppDefine.ViewLogicalLeft,s=LAppDefine.ViewLogicalRight;this._viewMatrix.setScreenRect(a,t,r,s),this._viewMatrix.scale(LAppDefine.ViewScale,LAppDefine.ViewScale),this._deviceToScreen.loadIdentity(),i<e?(t=Math.abs(t-a),this._deviceToScreen.scaleRelative(t/e,-t/e)):(a=Math.abs(s-r),this._deviceToScreen.scaleRelative(a/i,-a/i)),this._deviceToScreen.translateRelative(.5*-e,.5*-i),this._viewMatrix.setMaxScale(LAppDefine.ViewMaxScale),this._viewMatrix.setMinScale(LAppDefine.ViewMinScale),this._viewMatrix.setMaxScreenRect(LAppDefine.ViewLogicalMaxLeft,LAppDefine.ViewLogicalMaxRight,LAppDefine.ViewLogicalMaxBottom,LAppDefine.ViewLogicalMaxTop)}release(){this._viewMatrix=null,this._touchManager=null,this._deviceToScreen=null,this._gear.release(),this._gear=null,this._back.release(),this._back=null,this._subdelegate.getGlManager().getGl().deleteProgram(this._programId),this._programId=null}render(){this._subdelegate.getGlManager().getGl().useProgram(this._programId),this._back&&this._back.render(this._programId),this._gear&&this._gear.render(this._programId),this._subdelegate.getGlManager().getGl().flush();var e=this._subdelegate.getLive2DManager();null!=e&&(e.setViewMatrix(this._viewMatrix),e.onUpdate())}initializeSprite(){let s=this._subdelegate.getCanvas().width,n=this._subdelegate.getCanvas().height;var e,i=this._subdelegate.getTextureManager(),t=LAppDefine.ResourcesPath;i.createTextureFromPngFile(t+LAppDefine.BackImageName,!1,e=>{var i=.5*s,t=.5*n,a=2*e.width,r=.95*n;this._back=new LAppSprite(i,t,a,r,e.id),this._back.setSubdelegate(this._subdelegate)}),e=LAppDefine.GearImageName;i.createTextureFromPngFile(t+e,!1,e=>{var i=s-.5*e.width,t=n-.5*e.height;this._gear=new LAppSprite(i,t,e.width,e.height,e.id),this._gear.setSubdelegate(this._subdelegate)}),null==this._programId&&(this._programId=this._subdelegate.createShader())}onTouchesBegan(e,i){this._touchManager.touchesBegan(e*window.devicePixelRatio,i*window.devicePixelRatio)}onTouchesMoved(e,i){var e=e*window.devicePixelRatio,i=i*window.devicePixelRatio,t=this._subdelegate.getLive2DManager(),a=this.transformViewX(this._touchManager.getX()),r=this.transformViewY(this._touchManager.getY());this._touchManager.touchesMoved(e,i),t.onDrag(a,r)}onTouchesEnded(e,i){var e=e*window.devicePixelRatio,i=i*window.devicePixelRatio,t=this._subdelegate.getLive2DManager(),a=(t.onDrag(0,0),this.transformViewX(e)),r=this.transformViewY(i);LAppDefine.DebugTouchLogEnable&&LAppPal.printMessage(`[APP]touchesEnded x: ${a} y: `+r),t.onTap(a,r),this._gear.isHit(e,i)&&t.nextScene()}transformViewX(e){e=this._deviceToScreen.transformX(e);return this._viewMatrix.invertTransformX(e)}transformViewY(e){e=this._deviceToScreen.transformY(e);return this._viewMatrix.invertTransformY(e)}transformScreenX(e){return this._deviceToScreen.transformX(e)}transformScreenY(e){return this._deviceToScreen.transformY(e)}}export{LAppView};