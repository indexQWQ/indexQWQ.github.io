import{CubismDefaultParameterId}from"@framework/cubismdefaultparameterid";import{CubismModelSettingJson}from"@framework/cubismmodelsettingjson";import{BreathParameterData,CubismBreath}from"@framework/effect/cubismbreath";import{CubismEyeBlink}from"@framework/effect/cubismeyeblink";import{CubismFramework}from"@framework/live2dcubismframework";import{CubismUserModel}from"@framework/model/cubismusermodel";import{ACubismMotion}from"@framework/motion/acubismmotion";import{InvalidMotionQueueEntryHandleValue}from"@framework/motion/cubismmotionqueuemanager";import{csmMap}from"@framework/type/csmmap";import{csmVector}from"@framework/type/csmvector";import{CSM_ASSERT,CubismLogError,CubismLogInfo}from"@framework/utils/cubismdebug";import*as LAppDefine from"./lappdefine";import{LAppPal}from"./lapppal";import{LAppWavFileHandler}from"./lappwavfilehandler";import{CubismMoc}from"@framework/model/cubismmoc";var LoadStep;(e=>{e[e.LoadAssets=0]="LoadAssets",e[e.LoadModel=1]="LoadModel",e[e.WaitLoadModel=2]="WaitLoadModel",e[e.LoadExpression=3]="LoadExpression",e[e.WaitLoadExpression=4]="WaitLoadExpression",e[e.LoadPhysics=5]="LoadPhysics",e[e.WaitLoadPhysics=6]="WaitLoadPhysics",e[e.LoadPose=7]="LoadPose",e[e.WaitLoadPose=8]="WaitLoadPose",e[e.SetupEyeBlink=9]="SetupEyeBlink",e[e.SetupBreath=10]="SetupBreath",e[e.LoadUserData=11]="LoadUserData",e[e.WaitLoadUserData=12]="WaitLoadUserData",e[e.SetupEyeBlinkIds=13]="SetupEyeBlinkIds",e[e.SetupLipSyncIds=14]="SetupLipSyncIds",e[e.SetupLayout=15]="SetupLayout",e[e.LoadMotion=16]="LoadMotion",e[e.WaitLoadMotion=17]="WaitLoadMotion",e[e.CompleteInitialize=18]="CompleteInitialize",e[e.CompleteSetupModel=19]="CompleteSetupModel",e[e.LoadTexture=20]="LoadTexture",e[e.WaitLoadTexture=21]="WaitLoadTexture",e[e.CompleteSetup=22]="CompleteSetup"})(LoadStep=LoadStep||{});class LAppModel extends CubismUserModel{loadAssets(e,t){this._modelHomeDir=e,fetch(""+this._modelHomeDir+t).then(e=>e.arrayBuffer()).then(e=>{e=new CubismModelSettingJson(e,e.byteLength);this._state=LoadStep.LoadModel,this.setupModel(e)}).catch(e=>{CubismLogError("Failed to load file "+this._modelHomeDir+t)})}setupModel(e){if(this._updating=!0,this._initialized=!1,this._modelSetting=e,""!=this._modelSetting.getModelFileName()){let t=this._modelSetting.getModelFileName();fetch(""+this._modelHomeDir+t).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+t),new ArrayBuffer(0)):void 0).then(e=>{this.loadModel(e,this._mocConsistency),this._state=LoadStep.LoadExpression,i()}),this._state=LoadStep.WaitLoadModel}else LAppPal.printMessage("Model data does not exist.");let i=()=>{if(0<this._modelSetting.getExpressionCount()){let s=this._modelSetting.getExpressionCount();for(let e=0;e<s;e++){let t=this._modelSetting.getExpressionName(e),i=this._modelSetting.getExpressionFileName(e);fetch(""+this._modelHomeDir+i).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+i),new ArrayBuffer(0)):void 0).then(e=>{e=this.loadExpression(e,e.byteLength,t);null!=this._expressions.getValue(t)&&(ACubismMotion.delete(this._expressions.getValue(t)),this._expressions.setValue(t,null)),this._expressions.setValue(t,e),this._expressionCount++,this._expressionCount>=s&&(this._state=LoadStep.LoadPhysics,a())})}this._state=LoadStep.WaitLoadExpression}else this._state=LoadStep.LoadPhysics,a()},a=()=>{if(""!=this._modelSetting.getPhysicsFileName()){let t=this._modelSetting.getPhysicsFileName();fetch(""+this._modelHomeDir+t).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+t),new ArrayBuffer(0)):void 0).then(e=>{this.loadPhysics(e,e.byteLength),this._state=LoadStep.LoadPose,s()}),this._state=LoadStep.WaitLoadPhysics}else this._state=LoadStep.LoadPose,s()},s=()=>{if(""!=this._modelSetting.getPoseFileName()){let t=this._modelSetting.getPoseFileName();fetch(""+this._modelHomeDir+t).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+t),new ArrayBuffer(0)):void 0).then(e=>{this.loadPose(e,e.byteLength),this._state=LoadStep.SetupEyeBlink,o()}),this._state=LoadStep.WaitLoadPose}else this._state=LoadStep.SetupEyeBlink,o()},o=()=>{0<this._modelSetting.getEyeBlinkParameterCount()&&(this._eyeBlink=CubismEyeBlink.create(this._modelSetting),this._state=LoadStep.SetupBreath),t()},t=()=>{this._breath=CubismBreath.create();var e=new csmVector;e.pushBack(new BreathParameterData(this._idParamAngleX,0,15,6.5345,.5)),e.pushBack(new BreathParameterData(this._idParamAngleY,0,8,3.5345,.5)),e.pushBack(new BreathParameterData(this._idParamAngleZ,0,10,5.5345,.5)),e.pushBack(new BreathParameterData(this._idParamBodyAngleX,0,4,15.5345,.5)),e.pushBack(new BreathParameterData(CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamBreath),.5,.5,3.2345,1)),this._breath.setParameters(e),this._state=LoadStep.LoadUserData,r()},r=()=>{if(""!=this._modelSetting.getUserDataFile()){let t=this._modelSetting.getUserDataFile();fetch(""+this._modelHomeDir+t).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+t),new ArrayBuffer(0)):void 0).then(e=>{this.loadUserData(e,e.byteLength),this._state=LoadStep.SetupEyeBlinkIds,n()}),this._state=LoadStep.WaitLoadUserData}else this._state=LoadStep.SetupEyeBlinkIds,n()},n=()=>{var t=this._modelSetting.getEyeBlinkParameterCount();for(let e=0;e<t;++e)this._eyeBlinkIds.pushBack(this._modelSetting.getEyeBlinkParameterId(e));this._state=LoadStep.SetupLipSyncIds,l()},l=()=>{var t=this._modelSetting.getLipSyncParameterCount();for(let e=0;e<t;++e)this._lipSyncIds.pushBack(this._modelSetting.getLipSyncParameterId(e));this._state=LoadStep.SetupLayout,d()},d=()=>{var e=new csmMap;null==this._modelSetting||null==this._modelMatrix?CubismLogError("Failed to setupLayout()."):(this._modelSetting.getLayoutMap(e),this._modelMatrix.setupFromLayout(e),this._state=LoadStep.LoadMotion,m())},m=()=>{this._state=LoadStep.WaitLoadMotion,this._model.saveParameters(),this._allMotionCount=0,this._motionCount=0;var t=[],i=this._modelSetting.getMotionGroupCount();for(let e=0;e<i;e++)t[e]=this._modelSetting.getMotionGroupName(e),this._allMotionCount+=this._modelSetting.getMotionCount(t[e]);for(let e=0;e<i;e++)this.preLoadMotionGroup(t[e]);0==i&&(this._state=LoadStep.LoadTexture,this._motionManager.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(),this.setupTextures(),this.getRenderer().startUp(this._subdelegate.getGlManager().getGl()))}}setupTextures(){var e;if(this._state==LoadStep.LoadTexture){let i=this._modelSetting.getTextureCount();for(let t=0;t<i;t++)""==this._modelSetting.getTextureFileName(t)?console.log("getTextureFileName null"):(e=this._modelSetting.getTextureFileName(t),e=this._modelHomeDir+e,this._subdelegate.getTextureManager().createTextureFromPngFile(e,!0,e=>{this.getRenderer().bindTexture(t,e.id),this._textureCount++,this._textureCount>=i&&(this._state=LoadStep.CompleteSetup)}),this.getRenderer().setIsPremultipliedAlpha(!0));this._state=LoadStep.WaitLoadTexture}}reloadRenderer(){this.deleteRenderer(),this.createRenderer(),this.setupTextures()}update(){if(this._state==LoadStep.CompleteSetup){var t=LAppPal.getDeltaTime();this._userTimeSeconds+=t,this._dragManager.update(t),this._dragX=this._dragManager.getX(),this._dragY=this._dragManager.getY();let e=!1;if(this._model.loadParameters(),this._motionManager.isFinished()?this.startRandomMotion(LAppDefine.MotionGroupIdle,LAppDefine.PriorityIdle):e=this._motionManager.updateMotion(this._model,t),this._model.saveParameters(),e||null!=this._eyeBlink&&this._eyeBlink.updateParameters(this._model,t),null!=this._expressionManager&&this._expressionManager.updateMotion(this._model,t),this._model.addParameterValueById(this._idParamAngleX,30*this._dragX),this._model.addParameterValueById(this._idParamAngleY,30*this._dragY),this._model.addParameterValueById(this._idParamAngleZ,this._dragX*this._dragY*-30),this._model.addParameterValueById(this._idParamBodyAngleX,10*this._dragX),this._model.addParameterValueById(this._idParamEyeBallX,this._dragX),this._model.addParameterValueById(this._idParamEyeBallY,this._dragY),null!=this._breath&&this._breath.updateParameters(this._model,t),null!=this._physics&&this._physics.evaluate(this._model,t),this._lipsync){var i;this._wavFileHandler.update(t),i=this._wavFileHandler.getRms();for(let e=0;e<this._lipSyncIds.getSize();++e)this._model.addParameterValueById(this._lipSyncIds.at(e),i,.8)}null!=this._pose&&this._pose.updateParameters(this._model,t),this._model.update()}}startMotion(t,i,e,s,a){if(e==LAppDefine.PriorityForce)this._motionManager.setReservePriority(e);else if(!this._motionManager.reserveMotion(e))return this._debugMode&&LAppPal.printMessage("[APP]can't start motion."),InvalidMotionQueueEntryHandleValue;let o=this._modelSetting.getMotionFileName(t,i);let r=this._motions.getValue(t+"_"+i),n=!1;if(null==r){if(fetch(""+this._modelHomeDir+o).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+o),new ArrayBuffer(0)):void 0).then(e=>{r=this.loadMotion(e,e.byteLength,null,s,a,this._modelSetting,t,i,this._motionConsistency)}),!r)return CubismLogError("Can't start motion {0} .",o),this._motionManager.setReservePriority(LAppDefine.PriorityNone),InvalidMotionQueueEntryHandleValue;r.setEffectIds(this._eyeBlinkIds,this._lipSyncIds),n=!0}else r.setBeganMotionHandler(a),r.setFinishedMotionHandler(s);var l=this._modelSetting.getMotionSoundFileName(t,i);return 0!=l.localeCompare("")&&(l=this._modelHomeDir+(l=l),this._wavFileHandler.start(l)),this._debugMode&&LAppPal.printMessage(`[APP]start motion: [${t}_${i}]`),this._motionManager.startMotionPriority(r,n,e)}startRandomMotion(e,t,i,s){var a;return 0==this._modelSetting.getMotionCount(e)?InvalidMotionQueueEntryHandleValue:(a=Math.floor(Math.random()*this._modelSetting.getMotionCount(e)),this.startMotion(e,a,t,i,s))}setExpression(e){var t=this._expressions.getValue(e);this._debugMode&&LAppPal.printMessage(`[APP]expression: [${e}]`),null!=t?this._expressionManager.startMotion(t,!1):this._debugMode&&LAppPal.printMessage(`[APP]expression[${e}] is null`)}setRandomExpression(){if(0!=this._expressions.getSize()){var t,i=Math.floor(Math.random()*this._expressions.getSize());for(let e=0;e<this._expressions.getSize();e++)if(e==i)return t=this._expressions._keyValues[e].first,void this.setExpression(t)}}motionEventFired(e){CubismLogInfo("{0} is fired on LAppModel!!",e.s)}hitTest(t,i,s){if(!(this._opacity<1)){var a,o=this._modelSetting.getHitAreasCount();for(let e=0;e<o;e++)if(this._modelSetting.getHitAreaName(e)==t)return a=this._modelSetting.getHitAreaId(e),this.isHit(a,i,s)}return!1}preLoadMotionGroup(a){for(let s=0;s<this._modelSetting.getMotionCount(a);s++){let t=this._modelSetting.getMotionFileName(a,s),i=a+"_"+s;this._debugMode&&LAppPal.printMessage(`[APP]load motion: ${t} => [${i}]`),fetch(""+this._modelHomeDir+t).then(e=>e.ok?e.arrayBuffer():400<=e.status?(CubismLogError("Failed to load file "+this._modelHomeDir+t),new ArrayBuffer(0)):void 0).then(e=>{e=this.loadMotion(e,e.byteLength,i,null,null,this._modelSetting,a,s,this._motionConsistency);null!=e?(e.setEffectIds(this._eyeBlinkIds,this._lipSyncIds),null!=this._motions.getValue(i)&&ACubismMotion.delete(this._motions.getValue(i)),this._motions.setValue(i,e),this._motionCount++):this._allMotionCount--,this._motionCount>=this._allMotionCount&&(this._state=LoadStep.LoadTexture,this._motionManager.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(),this.setupTextures(),this.getRenderer().startUp(this._subdelegate.getGlManager().getGl()))})}}releaseMotions(){this._motions.clear()}releaseExpressions(){this._expressions.clear()}doDraw(){var e;null!=this._model&&(e=[0,0,(e=this._subdelegate.getCanvas()).width,e.height],this.getRenderer().setRenderState(this._subdelegate.getFrameBuffer(),e),this.getRenderer().drawModel())}draw(e){null!=this._model&&this._state==LoadStep.CompleteSetup&&(e.multiplyByMatrix(this._modelMatrix),this.getRenderer().setMvpMatrix(e),this.doDraw())}async hasMocConsistencyFromFile(){var e;if(CSM_ASSERT(this._modelSetting.getModelFileName().localeCompare("")),""!=this._modelSetting.getModelFileName())return e=this._modelSetting.getModelFileName(),e=await(await fetch(""+this._modelHomeDir+e)).arrayBuffer(),this._consistency=CubismMoc.hasMocConsistency(e),this._consistency?CubismLogInfo("Consistent MOC3."):CubismLogInfo("Inconsistent MOC3."),this._consistency;LAppPal.printMessage("Model data does not exist.")}setSubdelegate(e){this._subdelegate=e}constructor(){super(),this._modelSetting=null,this._modelHomeDir=null,this._userTimeSeconds=0,this._eyeBlinkIds=new csmVector,this._lipSyncIds=new csmVector,this._motions=new csmMap,this._expressions=new csmMap,this._hitArea=new csmVector,this._userArea=new csmVector,this._idParamAngleX=CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamAngleX),this._idParamAngleY=CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamAngleY),this._idParamAngleZ=CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamAngleZ),this._idParamEyeBallX=CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamEyeBallX),this._idParamEyeBallY=CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamEyeBallY),this._idParamBodyAngleX=CubismFramework.getIdManager().getId(CubismDefaultParameterId.ParamBodyAngleX),LAppDefine.MOCConsistencyValidationEnable&&(this._mocConsistency=!0),LAppDefine.MotionConsistencyValidationEnable&&(this._motionConsistency=!0),this._state=LoadStep.LoadAssets,this._expressionCount=0,this._textureCount=0,this._motionCount=0,this._allMotionCount=0,this._wavFileHandler=new LAppWavFileHandler,this._consistency=!1}}export{LAppModel};