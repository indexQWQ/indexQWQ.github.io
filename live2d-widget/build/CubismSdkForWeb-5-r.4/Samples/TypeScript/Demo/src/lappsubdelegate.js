import*as LAppDefine from"./lappdefine";import{LAppGlManager}from"./lappglmanager";import{LAppLive2DManager}from"./lapplive2dmanager";import{LAppPal}from"./lapppal";import{LAppTextureManager}from"./lapptexturemanager";import{LAppView}from"./lappview";class LAppSubdelegate{constructor(){this._canvas=null,this._glManager=new LAppGlManager,this._textureManager=new LAppTextureManager,this._live2dManager=new LAppLive2DManager,this._view=new LAppView,this._frameBuffer=null,this._captured=!1}release(){this._resizeObserver.unobserve(this._canvas),this._resizeObserver.disconnect(),this._resizeObserver=null,this._live2dManager.release(),this._live2dManager=null,this._view.release(),this._view=null,this._textureManager.release(),this._textureManager=null,this._glManager.release(),this._glManager=null}initialize(e){if(!this._glManager.initialize(e))return!1;this._canvas=e,"auto"===LAppDefine.CanvasSize?this.resizeCanvas():(e.width=LAppDefine.CanvasSize.width,e.height=LAppDefine.CanvasSize.height),this._textureManager.setGlManager(this._glManager);e=this._glManager.getGl();return this._frameBuffer||(this._frameBuffer=e.getParameter(e.FRAMEBUFFER_BINDING)),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this._view.initialize(this),this._view.initializeSprite(),this._live2dManager.initialize(this),this._resizeObserver=new ResizeObserver((e,i)=>this.resizeObserverCallback.call(this,e,i)),this._resizeObserver.observe(this._canvas),!0}onResize(){this.resizeCanvas(),this._view.initialize(this),this._view.initializeSprite()}resizeObserverCallback(e,i){"auto"===LAppDefine.CanvasSize&&(this._needResize=!0)}update(){var e;this._glManager.getGl().isContextLost()||(this._needResize&&(this.onResize(),this._needResize=!1),(e=this._glManager.getGl()).clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this._view.render())}createShader(){var e,i,a=this._glManager.getGl(),t=a.createShader(a.VERTEX_SHADER);return null==t?(LAppPal.printMessage("failed to create vertexShader"),null):(a.shaderSource(t,"precision mediump float;attribute vec3 position;attribute vec2 uv;varying vec2 vuv;void main(void){   gl_Position = vec4(position, 1.0);   vuv = uv;}"),a.compileShader(t),null==(e=a.createShader(a.FRAGMENT_SHADER))?(LAppPal.printMessage("failed to create fragmentShader"),null):(a.shaderSource(e,"precision mediump float;varying vec2 vuv;uniform sampler2D texture;void main(void){   gl_FragColor = texture2D(texture, vuv);}"),a.compileShader(e),i=a.createProgram(),a.attachShader(i,t),a.attachShader(i,e),a.deleteShader(t),a.deleteShader(e),a.linkProgram(i),a.useProgram(i),i))}getTextureManager(){return this._textureManager}getFrameBuffer(){return this._frameBuffer}getCanvas(){return this._canvas}getGlManager(){return this._glManager}getLive2DManager(){return this._live2dManager}resizeCanvas(){this._canvas.width=this._canvas.clientWidth*window.devicePixelRatio,this._canvas.height=this._canvas.clientHeight*window.devicePixelRatio;var e=this._glManager.getGl();e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)}onPointBegan(e,i){this._view?(this._captured=!0,e-=this._canvas.offsetLeft,i-=this._canvas.offsetTop,this._view.onTouchesBegan(e,i)):LAppPal.printMessage("view notfound")}onPointMoved(e,i){this._captured&&(e=e-this._canvas.offsetLeft,i=i-this._canvas.offsetTop,this._view.onTouchesMoved(e,i))}onPointEnded(e,i){this._captured=!1,this._view?(e-=this._canvas.offsetLeft,i-=this._canvas.offsetTop,this._view.onTouchesEnded(e,i)):LAppPal.printMessage("view notfound")}onTouchCancel(e,i){this._captured=!1,this._view?(e-=this._canvas.offsetLeft,i-=this._canvas.offsetTop,this._view.onTouchesEnded(e,i)):LAppPal.printMessage("view notfound")}isContextLost(){return this._glManager.getGl().isContextLost()}}export{LAppSubdelegate};