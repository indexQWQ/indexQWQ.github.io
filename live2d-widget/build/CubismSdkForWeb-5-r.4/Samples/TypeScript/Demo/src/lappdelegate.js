import{csmVector}from"@framework/type/csmvector";import{CubismFramework,Option}from"@framework/live2dcubismframework";import*as LAppDefine from"./lappdefine";import{LAppPal}from"./lapppal";import{LAppSubdelegate}from"./lappsubdelegate";import{CubismLogError}from"@framework/utils/cubismdebug";let s_instance=null;class LAppDelegate{static getInstance(){return s_instance=null==s_instance?new LAppDelegate:s_instance}static releaseInstance(){null!=s_instance&&s_instance.release(),s_instance=null}onPointerBegan(e){for(var t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onPointBegan(e.pageX,e.pageY)}onPointerMoved(e){for(var t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onPointMoved(e.pageX,e.pageY)}onPointerEnded(e){for(var t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onPointEnded(e.pageX,e.pageY)}onPointerCancel(e){for(var t=this._subdelegates.begin();t.notEqual(this._subdelegates.end());t.preIncrement())t.ptr().onTouchCancel(e.pageX,e.pageY)}onResize(){for(let e=0;e<this._subdelegates.getSize();e++)this._subdelegates.at(e).onResize()}run(){let e=()=>{if(null!=s_instance){LAppPal.updateTime();for(let e=0;e<this._subdelegates.getSize();e++)this._subdelegates.at(e).update();requestAnimationFrame(e)}};e()}release(){this.releaseEventListener(),this.releaseSubdelegates(),CubismFramework.dispose(),this._cubismOption=null}releaseEventListener(){document.removeEventListener("pointerup",this.pointBeganEventListener),this.pointBeganEventListener=null,document.removeEventListener("pointermove",this.pointMovedEventListener),this.pointMovedEventListener=null,document.removeEventListener("pointerdown",this.pointEndedEventListener),this.pointEndedEventListener=null,document.removeEventListener("pointerdown",this.pointCancelEventListener),this.pointCancelEventListener=null}releaseSubdelegates(){for(var e=this._subdelegates.begin();e.notEqual(this._subdelegates.end());e.preIncrement())e.ptr().release();this._subdelegates.clear(),this._subdelegates=null}initialize(){return this.initializeCubism(),this.initializeSubdelegates(),this.initializeEventListener(),!0}initializeEventListener(){this.pointBeganEventListener=this.onPointerBegan.bind(this),this.pointMovedEventListener=this.onPointerMoved.bind(this),this.pointEndedEventListener=this.onPointerEnded.bind(this),this.pointCancelEventListener=this.onPointerCancel.bind(this),document.addEventListener("pointerdown",this.pointBeganEventListener,{passive:!0}),document.addEventListener("pointermove",this.pointMovedEventListener,{passive:!0}),document.addEventListener("pointerup",this.pointEndedEventListener,{passive:!0}),document.addEventListener("pointercancel",this.pointCancelEventListener,{passive:!0})}initializeCubism(){LAppPal.updateTime(),this._cubismOption.logFunction=LAppPal.printMessage,this._cubismOption.loggingLevel=LAppDefine.CubismLoggingLevel,CubismFramework.startUp(this._cubismOption),CubismFramework.initialize()}initializeSubdelegates(){let t=100,n=100;var e,i;3<LAppDefine.CanvasNum?(e=Math.ceil(Math.sqrt(LAppDefine.CanvasNum)),i=Math.ceil(LAppDefine.CanvasNum/e),t=100/e,n=100/i):t=100/LAppDefine.CanvasNum,this._canvases.prepareCapacity(LAppDefine.CanvasNum),this._subdelegates.prepareCapacity(LAppDefine.CanvasNum);for(let e=0;e<LAppDefine.CanvasNum;e++){var s=document.createElement("canvas");this._canvases.pushBack(s),s.style.width=t+"vw",s.style.height=n+"vh",document.body.appendChild(s)}for(let e=0;e<this._canvases.getSize();e++){var a=new LAppSubdelegate;a.initialize(this._canvases.at(e)),this._subdelegates.pushBack(a)}for(let e=0;e<LAppDefine.CanvasNum;e++)this._subdelegates.at(e).isContextLost()&&CubismLogError(`The context for Canvas at index ${e} was lost, possibly because the acquisition limit for WebGLRenderingContext was reached.`)}constructor(){this._cubismOption=new Option,this._subdelegates=new csmVector,this._canvases=new csmVector}}export{s_instance,LAppDelegate};