import{ModelManager}from"./model.js";import{showMessage,welcomeMessage}from"./message.js";import{randomSelection}from"./utils.js";import{ToolsManager}from"./tools.js";import logger from"./logger.js";import registerDrag from"./drag.js";import{fa_child}from"./icons.js";function registerEventListener(o){let e=!1,t,s=o.message.default;o.seasons.forEach(({date:e,text:t})=>{var i=new Date,a=e.split("-")[0],e=e.split("-")[1]||a;Number(a.split("/")[0])<=i.getMonth()+1&&i.getMonth()+1<=Number(e.split("/")[0])&&Number(a.split("/")[1])<=i.getDate()&&i.getDate()<=Number(e.split("/")[1])&&(t=(t=randomSelection(t)).replace("{year}",String(i.getFullYear())),s.push(t))});let r;window.addEventListener("mousemove",()=>e=!0),window.addEventListener("keydown",()=>e=!0),setInterval(()=>{t=e?(e=!1,clearInterval(t),null):t||setInterval(()=>{showMessage(s,6e3,9)},2e4)},1e3),window.addEventListener("mouseover",e=>{var t,i,a;for({selector:i,text:a}of o.mouseover)if(null!=(t=e.target)&&t.closest(i))return r===i?void 0:(r=i,a=(a=randomSelection(a)).replace("{text}",e.target.innerText),void showMessage(a,4e3,8))}),window.addEventListener("click",e=>{var t,i,a;for({selector:i,text:a}of o.click)if(null!=(t=e.target)&&t.closest(i))return a=(a=randomSelection(a)).replace("{text}",e.target.innerText),void showMessage(a,4e3,8)}),window.addEventListener("live2d:hoverbody",()=>{var e=randomSelection(o.message.hoverBody);showMessage(e,4e3,8,!1)}),window.addEventListener("live2d:tapbody",()=>{var e=randomSelection(o.message.tapBody);showMessage(e,4e3,9)});var i=()=>{};console.log("%c",i),i.toString=()=>{showMessage(o.message.console,6e3,9)},window.addEventListener("copy",()=>{showMessage(o.message.copy,6e3,9)}),window.addEventListener("visibilitychange",()=>{document.hidden||showMessage(o.message.visibilitychange,6e3,9)})}async function loadWidget(e){localStorage.removeItem("waifu-display"),sessionStorage.removeItem("waifu-message-priority"),document.body.insertAdjacentHTML("beforeend",`<div id="waifu">
       <div id="waifu-tips"></div>
       <div id="waifu-canvas">
         <canvas id="live2d" width="800" height="800"></canvas>
       </div>
       <div id="waifu-tool"></div>
     </div>`);let t=[],i;e.waifuPath&&(a=await fetch(e.waifuPath),i=await a.json(),t=i.models,registerEventListener(i),showMessage(welcomeMessage(i.time,i.message.welcome,i.message.referrer),7e3,11));var a=await ModelManager.initCheck(e,t);await a.loadModel(""),new ToolsManager(a,e,i).registerTools(),e.drag&&registerDrag(),null!=(a=document.getElementById("waifu"))&&a.classList.add("waifu-active")}function initWidget(i){if("string"==typeof i)logger.error("Your config for Live2D initWidget is outdated. Please refer to https://github.com/stevenjoezhang/live2d-widget/blob/master/dist/autoload.js");else{logger.setLevel(i.logLevel),document.body.insertAdjacentHTML("beforeend",`<div id="waifu-toggle">
       ${fa_child}
     </div>`);let t=document.getElementById("waifu-toggle");null!=t&&t.addEventListener("click",()=>{var e;null!=t&&t.classList.remove("waifu-toggle-active"),null!=t&&t.getAttribute("first-time")?(loadWidget(i),null!=t&&t.removeAttribute("first-time")):(localStorage.removeItem("waifu-display"),null!=(e=document.getElementById("waifu"))&&e.classList.remove("waifu-hidden"),setTimeout(()=>{var e;null!=(e=document.getElementById("waifu"))&&e.classList.add("waifu-active")},0))}),localStorage.getItem("waifu-display")&&Date.now()-Number(localStorage.getItem("waifu-display"))<=864e5?(null!=t&&t.setAttribute("first-time","true"),setTimeout(()=>{null!=t&&t.classList.add("waifu-toggle-active")},0)):loadWidget(i)}}export{initWidget};