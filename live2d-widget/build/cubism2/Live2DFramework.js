import logger from"../logger.js";class L2DBaseModel{constructor(){this.live2DModel=null,this.modelMatrix=null,this.eyeBlink=null,this.physics=null,this.pose=null,this.initialized=!1,this.updating=!1,this.alpha=1,this.accAlpha=0,this.lipSync=!1,this.lipSyncValue=0,this.accelX=0,this.accelY=0,this.accelZ=0,this.dragX=0,this.dragY=0,this.startTimeMSec=null,this.mainMotionManager=new L2DMotionManager,this.expressionManager=new L2DMotionManager,this.motions={},this.expressions={},this.isTexLoaded=!1}getModelMatrix(){return this.modelMatrix}setAlpha(t){this.alpha=t=(t=.999<t?1:t)<.001?0:t}getAlpha(){return this.alpha}isInitialized(){return this.initialized}setInitialized(t){this.initialized=t}isUpdating(){return this.updating}setUpdating(t){this.updating=t}getLive2DModel(){return this.live2DModel}setLipSync(t){this.lipSync=t}setLipSyncValue(t){this.lipSyncValue=t}setAccel(t,e,i){this.accelX=t,this.accelY=e,this.accelZ=i}setDrag(t,e){this.dragX=t,this.dragY=e}getMainMotionManager(){return this.mainMotionManager}getExpressionManager(){return this.expressionManager}loadModelData(t,e){var i=Live2DFramework.getPlatformManager();logger.info("Load model : "+t),i.loadLive2DModel(t,t=>{this.live2DModel=t,this.live2DModel.saveParam(),0!=Live2D.getError()?logger.error("Error : Failed to loadModelData()."):(this.modelMatrix=new L2DModelMatrix(this.live2DModel.getCanvasWidth(),this.live2DModel.getCanvasHeight()),this.modelMatrix.setWidth(2),this.modelMatrix.setCenterPosition(0,0),e(this.live2DModel))})}loadTexture(t,e,i){texCounter++;var s=Live2DFramework.getPlatformManager();logger.info("Load Texture : "+e),s.loadTexture(this.live2DModel,t,e,()=>{0==--texCounter&&(this.isTexLoaded=!0),"function"==typeof i&&i()})}loadMotion(e,t,i){var s=Live2DFramework.getPlatformManager();logger.trace("Load Motion : "+t);let r;s.loadBytes(t,t=>{r=Live2DMotion.loadMotion(t),null!=e&&(this.motions[e]=r),i(r)})}loadExpression(e,t,i){var s=Live2DFramework.getPlatformManager();logger.trace("Load Expression : "+t),s.loadBytes(t,t=>{null!=e&&(this.expressions[e]=L2DExpressionMotion.loadJson(t)),"function"==typeof i&&i()})}loadPose(t,e){var i=Live2DFramework.getPlatformManager();logger.trace("Load Pose : "+t);try{i.loadBytes(t,t=>{this.pose=L2DPose.load(t),"function"==typeof e&&e()})}catch(t){logger.warn(t)}}loadPhysics(t){var e=Live2DFramework.getPlatformManager();logger.trace("Load Physics : "+t);try{e.loadBytes(t,t=>{this.physics=L2DPhysics.load(t)})}catch(t){logger.warn(t)}}hitTestSimple(t,e,i){t=this.live2DModel.getDrawDataIndex(t);if(t<0)return!1;var s=this.live2DModel.getTransformedPoints(t);let r=this.live2DModel.getCanvasWidth(),a=0,o=this.live2DModel.getCanvasHeight(),n=0;for(let t=0;t<s.length;t+=2){var h=s[t],l=s[t+1];h<r&&(r=h),h>a&&(a=h),l<o&&(o=l),l>n&&(n=l)}t=this.modelMatrix.invertTransformX(e),e=this.modelMatrix.invertTransformY(i);return r<=t&&t<=a&&o<=e&&e<=n}}let texCounter=0;class L2DExpressionMotion extends AMotion{constructor(){super(),this.paramList=[]}static loadJson(t){var s=new L2DExpressionMotion,t=Live2DFramework.getPlatformManager().jsonParseFromBytes(t);if(s.setFadeIn(0<parseInt(t.fade_in)?parseInt(t.fade_in):1e3),s.setFadeOut(0<parseInt(t.fade_out)?parseInt(t.fade_out):1e3),null!=t.params){var r=t.params,e=r.length;s.paramList=[];for(let i=0;i<e;i++){var a=r[i],o=a.id.toString();let e=parseFloat(a.val),t=L2DExpressionMotion.TYPE_ADD;var n=null!=a.calc?a.calc.toString():"add";if((t="add"===n?L2DExpressionMotion.TYPE_ADD:"mult"===n?L2DExpressionMotion.TYPE_MULT:"set"===n?L2DExpressionMotion.TYPE_SET:L2DExpressionMotion.TYPE_ADD)==L2DExpressionMotion.TYPE_ADD){n=null==a.def?0:parseFloat(a.def);e-=n}else if(t==L2DExpressionMotion.TYPE_MULT){let t=null==a.def?1:parseFloat(a.def);0==t&&(t=1),e/=t}n=new L2DExpressionParam;n.id=o,n.type=t,n.value=e,s.paramList.push(n)}}return s}updateParamExe(e,t,i,s){for(let t=this.paramList.length-1;0<=t;--t){var r=this.paramList[t];r.type==L2DExpressionMotion.TYPE_ADD?e.addToParamFloat(r.id,r.value,i):r.type==L2DExpressionMotion.TYPE_MULT?e.multParamFloat(r.id,r.value,i):r.type==L2DExpressionMotion.TYPE_SET&&e.setParamFloat(r.id,r.value,i)}}}function L2DExpressionParam(){this.id="",this.type=-1,this.value=null}L2DExpressionMotion.EXPRESSION_DEFAULT="DEFAULT",L2DExpressionMotion.TYPE_SET=0,L2DExpressionMotion.TYPE_ADD=1,L2DExpressionMotion.TYPE_MULT=2;class L2DEyeBlink{constructor(){this.nextBlinkTime=null,this.stateStartTime=null,this.blinkIntervalMsec=null,this.eyeState=EYE_STATE.STATE_FIRST,this.blinkIntervalMsec=4e3,this.closingMotionMsec=100,this.closedMotionMsec=50,this.openingMotionMsec=150,this.closeIfZero=!0,this.eyeID_L="PARAM_EYE_L_OPEN",this.eyeID_R="PARAM_EYE_R_OPEN"}calcNextBlink(){return UtSystem.getUserTimeMSec()+Math.random()*(2*this.blinkIntervalMsec-1)}setInterval(t){this.blinkIntervalMsec=t}setEyeMotion(t,e,i){this.closingMotionMsec=t,this.closedMotionMsec=e,this.openingMotionMsec=i}updateParam(t){var e=UtSystem.getUserTimeMSec();let i,s=0;switch(this.eyeState){case EYE_STATE.STATE_CLOSING:1<=(s=(e-this.stateStartTime)/this.closingMotionMsec)&&(s=1,this.eyeState=EYE_STATE.STATE_CLOSED,this.stateStartTime=e),i=1-s;break;case EYE_STATE.STATE_CLOSED:1<=(s=(e-this.stateStartTime)/this.closedMotionMsec)&&(this.eyeState=EYE_STATE.STATE_OPENING,this.stateStartTime=e),i=0;break;case EYE_STATE.STATE_OPENING:1<=(s=(e-this.stateStartTime)/this.openingMotionMsec)&&(s=1,this.eyeState=EYE_STATE.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink()),i=s;break;case EYE_STATE.STATE_INTERVAL:this.nextBlinkTime<e&&(this.eyeState=EYE_STATE.STATE_CLOSING,this.stateStartTime=e),i=1;break;default:EYE_STATE.STATE_FIRST;this.eyeState=EYE_STATE.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink(),i=1}this.closeIfZero||(i=-i),t.setParamFloat(this.eyeID_L,i),t.setParamFloat(this.eyeID_R,i)}}let EYE_STATE=()=>{};EYE_STATE.STATE_FIRST="STATE_FIRST",EYE_STATE.STATE_INTERVAL="STATE_INTERVAL",EYE_STATE.STATE_CLOSING="STATE_CLOSING",EYE_STATE.STATE_CLOSED="STATE_CLOSED",EYE_STATE.STATE_OPENING="STATE_OPENING";class L2DMatrix44{constructor(){this.tr=new Float32Array(16),this.identity()}static mul(t,e,i){var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let r,a,o;for(r=0;r<4;r++)for(a=0;a<4;a++)for(o=0;o<4;o++)s[r+4*a]+=t[r+4*o]*e[o+4*a];for(r=0;r<16;r++)i[r]=s[r]}identity(){for(let t=0;t<16;t++)this.tr[t]=t%5==0?1:0}getArray(){return this.tr}getCopyMatrix(){return new Float32Array(this.tr)}setMatrix(e){if(null!=this.tr&&this.tr.length==this.tr.length)for(let t=0;t<16;t++)this.tr[t]=e[t]}getScaleX(){return this.tr[0]}getScaleY(){return this.tr[5]}transformX(t){return this.tr[0]*t+this.tr[12]}transformY(t){return this.tr[5]*t+this.tr[13]}invertTransformX(t){return(t-this.tr[12])/this.tr[0]}invertTransformY(t){return(t-this.tr[13])/this.tr[5]}multTranslate(t,e){t=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];L2DMatrix44.mul(t,this.tr,this.tr)}translate(t,e){this.tr[12]=t,this.tr[13]=e}translateX(t){this.tr[12]=t}translateY(t){this.tr[13]=t}multScale(t,e){t=[t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1];L2DMatrix44.mul(t,this.tr,this.tr)}scale(t,e){this.tr[0]=t,this.tr[5]=e}}class L2DModelMatrix extends L2DMatrix44{constructor(t,e){super(),this.width=t,this.height=e}setPosition(t,e){this.translate(t,e)}setCenterPosition(t,e){var i=this.width*this.getScaleX(),s=this.height*this.getScaleY();this.translate(t-i/2,e-s/2)}top(t){this.setY(t)}bottom(t){var e=this.height*this.getScaleY();this.translateY(t-e)}left(t){this.setX(t)}right(t){var e=this.width*this.getScaleX();this.translateX(t-e)}centerX(t){var e=this.width*this.getScaleX();this.translateX(t-e/2)}centerY(t){var e=this.height*this.getScaleY();this.translateY(t-e/2)}setX(t){this.translateX(t)}setY(t){this.translateY(t)}setHeight(t){t/=this.height;this.scale(t,-t)}setWidth(t){t/=this.width;this.scale(t,-t)}}class L2DMotionManager extends MotionQueueManager{constructor(){super(),this.currentPriority=null,this.reservePriority=null,this.super=MotionQueueManager.prototype}getCurrentPriority(){return this.currentPriority}getReservePriority(){return this.reservePriority}reserveMotion(t){return!(this.reservePriority>=t||this.currentPriority>=t||(this.reservePriority=t,0))}setReservePriority(t){this.reservePriority=t}updateParam(t){t=MotionQueueManager.prototype.updateParam.call(this,t);return this.isFinished()&&(this.currentPriority=0),t}startMotionPrio(t,e){return e==this.reservePriority&&(this.reservePriority=0),this.currentPriority=e,this.startMotion(t,!1)}}class L2DPhysics{constructor(){this.physicsList=[],this.startTimeMSec=UtSystem.getUserTimeMSec()}static load(t){var e=new L2DPhysics,i=Live2DFramework.getPlatformManager().jsonParseFromBytes(t).physics_hair,s=i.length;for(let t=0;t<s;t++){var r=i[t],a=new PhysicsHair,o=r.setup,n=parseFloat(o.length),h=parseFloat(o.regist),o=parseFloat(o.mass),l=(a.setup(n,h,o),r.src),c=l.length;for(let e=0;e<c;e++){var g=l[e],T=g.id;let t=PhysicsHair.Src.SRC_TO_X;var m=g.ptype,m=("x"===m?t=PhysicsHair.Src.SRC_TO_X:"y"===m?t=PhysicsHair.Src.SRC_TO_Y:"angle"===m?t=PhysicsHair.Src.SRC_TO_G_ANGLE:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Src"),parseFloat(g.scale)),g=parseFloat(g.weight);a.addSrcParam(t,T,m,g)}var p=r.targets,M=p.length;for(let e=0;e<M;e++){var u=p[e],d=u.id;let t=PhysicsHair.Target.TARGET_FROM_ANGLE;var E=u.ptype,E=("angle"===E?t=PhysicsHair.Target.TARGET_FROM_ANGLE:"angle_v"===E?t=PhysicsHair.Target.TARGET_FROM_ANGLE_V:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Target"),parseFloat(u.scale)),u=parseFloat(u.weight);a.addTargetParam(t,d,E,u)}e.physicsList.push(a)}return e}updateParam(e){var i=UtSystem.getUserTimeMSec()-this.startTimeMSec;for(let t=0;t<this.physicsList.length;t++)this.physicsList[t].update(e,i)}}class L2DPose{constructor(){this.lastTime=0,this.lastModel=null,this.partsGroups=[]}static load(t){var e=new L2DPose,i=Live2DFramework.getPlatformManager().jsonParseFromBytes(t).parts_visible,s=i.length;for(let t=0;t<s;t++){var r=i[t].group,a=r.length,o=[];for(let t=0;t<a;t++){var n=r[t],h=new L2DPartsParam(n.id);if(o[t]=h,null!=n.link){var l=n.link,c=l.length;h.link=[];for(let t=0;t<c;t++){var g=new L2DPartsParam(l[t]);h.link.push(g)}}}e.partsGroups.push(o)}return e}updateParam(i){if(null!=i){i!=this.lastModel&&this.initParam(i),this.lastModel=i;var t=UtSystem.getUserTimeMSec();let e=0==this.lastTime?0:(t-this.lastTime)/1e3;this.lastTime=t,e<0&&(e=0);for(let t=0;t<this.partsGroups.length;t++)this.normalizePartsOpacityGroup(i,this.partsGroups[t],e),this.copyOpacityOtherParts(i,this.partsGroups[t])}}initParam(i){if(null!=i)for(let t=0;t<this.partsGroups.length;t++){var s=this.partsGroups[t];for(let e=0;e<s.length;e++){s[e].initIndex(i);var r=s[e].partsIndex,a=s[e].paramIndex;if(!(r<0)){var o=0!=i.getParamFloat(a);if(i.setPartsOpacity(r,o?1:0),i.setParamFloat(a,o?1:0),null!=s[e].link)for(let t=0;t<s[e].link.length;t++)s[e].link[t].initIndex(i)}}}}normalizePartsOpacityGroup(i,e,s){let r=-1,a=1;for(let t=0;t<e.length;t++){var o=e[t].partsIndex,n=e[t].paramIndex;if(!(o<0)&&0!=i.getParamFloat(n)){if(0<=r)break;r=t,a=i.getPartsOpacity(o),1<(a+=s/.5)&&(a=1)}}r<0&&(r=0,a=1);for(let t=0;t<e.length;t++){var h=e[t].partsIndex;if(!(h<0))if(r==t)i.setPartsOpacity(h,a);else{let t=i.getPartsOpacity(h),e;.15<(1-(e=a<.5?-.5*a/.5+1:.5*(1-a)/.5))*(1-a)&&(e=1-.15/(1-a)),t>e&&(t=e),i.setPartsOpacity(h,t)}}}copyOpacityOtherParts(e,i){for(let t=0;t<i.length;t++){var s=i[t];if(null!=s.link&&!(s.partsIndex<0)){var r=e.getPartsOpacity(s.partsIndex);for(let t=0;t<s.link.length;t++){var a=s.link[t];a.partsIndex<0||e.setPartsOpacity(a.partsIndex,r)}}}}}class L2DPartsParam{constructor(t){this.paramIndex=-1,this.partsIndex=-1,this.link=null,this.id=t}initIndex(t){this.paramIndex=t.getParamIndex("VISIBLE:"+this.id),this.partsIndex=t.getPartsDataIndex(PartsDataID.getID(this.id)),t.setParamFloat(this.paramIndex,1)}}class L2DTargetPoint{constructor(){this.EPSILON=.01,this.faceTargetX=0,this.faceTargetY=0,this.faceX=0,this.faceY=0,this.faceVX=0,this.faceVY=0,this.lastTimeSec=0}setPoint(t,e){this.faceTargetX=t,this.faceTargetY=e}getX(){return this.faceX}getY(){return this.faceY}update(){var i=40/7.5/L2DTargetPoint.FRAME_RATE;if(0==this.lastTimeSec)this.lastTimeSec=UtSystem.getUserTimeMSec();else{var s=UtSystem.getUserTimeMSec(),r=(s-this.lastTimeSec)*L2DTargetPoint.FRAME_RATE/1e3,s=(this.lastTimeSec=s,.15*L2DTargetPoint.FRAME_RATE),r=r*i/s,s=this.faceTargetX-this.faceX,a=this.faceTargetY-this.faceY;if(!(Math.abs(s)<=this.EPSILON&&Math.abs(a)<=this.EPSILON)){var o=Math.sqrt(s*s+a*a);let t=i*s/o-this.faceVX,e=i*a/o-this.faceVY;s=Math.sqrt(t*t+e*e),i=((s<-r||r<s)&&(t*=r/s,e*=r/s,0),this.faceVX+=t,this.faceVY+=e,.5*(Math.sqrt(r*r+16*r*o-8*r*o)-r)),a=Math.sqrt(this.faceVX*this.faceVX+this.faceVY*this.faceVY);i<a&&(this.faceVX*=i/a,this.faceVY*=i/a),this.faceX+=this.faceVX,this.faceY+=this.faceVY}}}}L2DTargetPoint.FRAME_RATE=30;class L2DViewMatrix extends L2DMatrix44{constructor(){super(),this.screenLeft=null,this.screenRight=null,this.screenTop=null,this.screenBottom=null,this.maxLeft=null,this.maxRight=null,this.maxTop=null,this.maxBottom=null,this.max=Number.MAX_VALUE,this.min=0}getMaxScale(){return this.max}getMinScale(){return this.min}setMaxScale(t){this.max=t}setMinScale(t){this.min=t}isMaxScale(){return this.getScaleX()==this.max}isMinScale(){return this.getScaleX()==this.min}adjustTranslate(t,e){this.tr[0]*this.maxLeft+(this.tr[12]+t)>this.screenLeft&&(t=this.screenLeft-this.tr[0]*this.maxLeft-this.tr[12]),this.tr[0]*this.maxRight+(this.tr[12]+t)<this.screenRight&&(t=this.screenRight-this.tr[0]*this.maxRight-this.tr[12]),this.tr[5]*this.maxTop+(this.tr[13]+e)<this.screenTop&&(e=this.screenTop-this.tr[5]*this.maxTop-this.tr[13]);t=[1,0,0,0,0,1,0,0,0,0,1,0,t,e=this.tr[5]*this.maxBottom+(this.tr[13]+e)>this.screenBottom?this.screenBottom-this.tr[5]*this.maxBottom-this.tr[13]:e,0,1];L2DMatrix44.mul(t,this.tr,this.tr)}adjustScale(t,e,i){var s=i*this.tr[0],s=(s<this.min?0<this.tr[0]&&(i=this.min/this.tr[0]):s>this.max&&0<this.tr[0]&&(i=this.max/this.tr[0]),[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]),i=[i,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1],t=[1,0,0,0,0,1,0,0,0,0,1,0,-t,-e,0,1];L2DMatrix44.mul(t,this.tr,this.tr),L2DMatrix44.mul(i,this.tr,this.tr),L2DMatrix44.mul(s,this.tr,this.tr)}setScreenRect(t,e,i,s){this.screenLeft=t,this.screenRight=e,this.screenTop=s,this.screenBottom=i}setMaxScreenRect(t,e,i,s){this.maxLeft=t,this.maxRight=e,this.maxTop=s,this.maxBottom=i}getScreenLeft(){return this.screenLeft}getScreenRight(){return this.screenRight}getScreenBottom(){return this.screenBottom}getScreenTop(){return this.screenTop}getMaxLeft(){return this.maxLeft}getMaxRight(){return this.maxRight}getMaxBottom(){return this.maxBottom}getMaxTop(){return this.maxTop}}class Live2DFramework{static getPlatformManager(){return Live2DFramework.platformManager}static setPlatformManager(t){Live2DFramework.platformManager=t}}Live2DFramework.platformManager=null;export{L2DBaseModel,L2DViewMatrix,L2DEyeBlink,Live2DFramework,L2DMatrix44,L2DTargetPoint};